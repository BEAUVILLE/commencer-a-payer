<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DIGIY ‚Ä¢ Dashboard Caisse Centrale</title>
  <meta name="theme-color" content="#16a34a"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --gold:#facc15;
      --radius:18px; --shadow:0 18px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    body{ 
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; 
      background:var(--bg); 
      color:var(--text);
      padding:16px;
    }
    .wrap{ max-width:1400px; margin:0 auto; }
    .card{ 
      background:var(--card); 
      border:1px solid var(--line); 
      border-radius:var(--radius); 
      padding:20px; 
      box-shadow:var(--shadow); 
      margin-bottom:16px;
    }
    h1{ font-size:28px; font-weight:1200; margin-bottom:8px; }
    h2{ font-size:20px; font-weight:1100; margin-bottom:12px; }
    h3{ font-size:16px; font-weight:1000; margin-bottom:8px; }
    .small{ font-size:13px; color:var(--muted); line-height:1.4; }
    .hr{ height:1px; background:var(--line); margin:16px 0; }
    
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));
      gap:16px;
      margin-bottom:20px;
    }
    .kpi{
      background:rgba(0,0,0,.2);
      border:1px solid var(--line);
      border-radius:16px;
      padding:20px;
      text-align:center;
    }
    .kpi-icon{ font-size:36px; margin-bottom:8px; }
    .kpi-value{ font-size:32px; font-weight:1200; margin:8px 0; }
    .kpi-label{ font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; }
    .kpi.ok{ border-color:rgba(34,197,94,.55); }
    .kpi.warn{ border-color:rgba(245,158,11,.55); }
    .kpi.gold{ border-color:rgba(250,204,21,.55); }
    
    .chart-container{
      position:relative;
      height:300px;
      margin:20px 0;
    }
    
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:16px;
    }
    th{
      background:rgba(0,0,0,.3);
      padding:12px;
      text-align:left;
      font-weight:1100;
      border-bottom:2px solid var(--line);
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    td{
      padding:12px;
      border-bottom:1px solid var(--line);
      font-size:14px;
    }
    tr:hover{ background:rgba(255,255,255,.05); }
    
    .badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      font-size:11px;
      font-weight:1000;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .badge.ok{ background:rgba(34,197,94,.2); color:var(--ok); border:1px solid rgba(34,197,94,.5); }
    .badge.warn{ background:rgba(245,158,11,.2); color:var(--warn); border:1px solid rgba(245,158,11,.5); }
    .badge.bad{ background:rgba(239,68,68,.2); color:var(--bad); border:1px solid rgba(239,68,68,.5); }
    
    .btn{
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      padding:12px 20px;
      border-radius:12px;
      cursor:pointer;
      font-weight:1000;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{ background:rgba(255,255,255,.1); }
    .btn.ok{ border-color:rgba(34,197,94,.55); }
    
    .filters{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:20px;
    }
    select{
      padding:10px 16px;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(0,0,0,.2);
      color:var(--text);
      font-weight:500;
      cursor:pointer;
    }
    
    .auth-box{
      max-width:400px;
      margin:100px auto;
      text-align:center;
    }
    input[type="tel"], input[type="password"]{
      width:100%;
      padding:14px;
      margin:10px 0;
      border:1px solid var(--line);
      border-radius:12px;
      background:rgba(0,0,0,.2);
      color:var(--text);
      font-size:16px;
      font-weight:500;
    }
    
    .mono{ font-family: ui-monospace, Menlo, Monaco, monospace; }
    
    #loading{
      display:none;
      text-align:center;
      padding:40px;
      font-size:18px;
      color:var(--muted);
    }
    
    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }
    @media(max-width:768px){
      .grid-2{ grid-template-columns:1fr; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- AUTH BOX -->
    <div class="card auth-box" id="authBox">
      <h1>üîê Acc√®s Dashboard</h1>
      <p class="small">R√©serv√© au propri√©taire DIGIYLYFE</p>
      <div class="hr"></div>
      <input type="tel" id="authPhone" placeholder="T√©l√©phone (+221...)">
      <input type="password" id="authPin" placeholder="PIN">
      <button class="btn ok" id="btnAuth" style="width:100%; margin-top:10px;">
        ‚úÖ Connexion
      </button>
      <p class="small" style="margin-top:12px;" id="authError"></p>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" style="display:none;">
      <!-- HEADER -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
          <div>
            <h1>üè¶ CAISSE CENTRALE DIGIYLYFE</h1>
            <p class="small">Dashboard temps r√©el ‚Ä¢ 0% Commission ‚Ä¢ Made in S√©n√©gal üá∏üá≥</p>
          </div>
          <div style="display:flex; gap:10px;">
            <button class="btn ok" id="btnRefresh">üîÑ Actualiser</button>
            <button class="btn" id="btnLogout">üö™ D√©connexion</button>
          </div>
        </div>
      </div>

      <!-- LOADING -->
      <div id="loading">‚è≥ Chargement des donn√©es...</div>

      <!-- KPIs -->
      <div class="kpi-grid" id="kpiGrid">
        <div class="kpi gold">
          <div class="kpi-icon">üí∞</div>
          <div class="kpi-value" id="kpiTotal">‚Äî</div>
          <div class="kpi-label">Total Encaissements</div>
        </div>
        
        <div class="kpi ok">
          <div class="kpi-icon">‚úÖ</div>
          <div class="kpi-value" id="kpiConfirmes">‚Äî</div>
          <div class="kpi-label">Confirm√©s / Actifs</div>
        </div>
        
        <div class="kpi warn">
          <div class="kpi-icon">‚è≥</div>
          <div class="kpi-value" id="kpiAttente">‚Äî</div>
          <div class="kpi-label">En Attente</div>
        </div>
        
        <div class="kpi gold">
          <div class="kpi-icon">üìä</div>
          <div class="kpi-value" id="kpiMRR">‚Äî</div>
          <div class="kpi-label">MRR (Monthly)</div>
        </div>
      </div>

      <!-- CHARTS -->
      <div class="grid-2">
        <div class="card">
          <h3>üì¶ Encaissements par Module</h3>
          <div class="chart-container">
            <canvas id="chartModules"></canvas>
          </div>
        </div>
        
        <div class="card">
          <h3>üìà √âvolution des Encaissements</h3>
          <div class="chart-container">
            <canvas id="chartTimeline"></canvas>
          </div>
        </div>
      </div>

      <!-- FILTERS -->
      <div class="card">
        <h2>üìã Liste des Encaissements</h2>
        <div class="filters">
          <select id="filterStatut">
            <option value="">Tous les statuts</option>
            <option value="EN_ATTENTE">En attente</option>
            <option value="WAVE_RECU">Wave re√ßu</option>
            <option value="CONFIRME">Confirm√©</option>
            <option value="ACTIF">Actif</option>
            <option value="ANNULE">Annul√©</option>
          </select>
          
          <select id="filterModule">
            <option value="">Tous les modules</option>
            <option value="RESTO_PRO">RESTO PRO</option>
            <option value="RESTO_RESA">RESTO R√âSA</option>
            <option value="POS_PRO">POS PRO</option>
            <option value="DRIVER">DRIVER</option>
            <option value="LOC">LOC</option>
            <option value="MARKET">MARKET</option>
            <option value="JOBS">JOBS</option>
            <option value="BUILD">BUILD</option>
          </select>
          
          <select id="filterPeriode">
            <option value="7">7 derniers jours</option>
            <option value="30" selected>30 derniers jours</option>
            <option value="90">90 derniers jours</option>
            <option value="365">1 an</option>
            <option value="all">Tout</option>
          </select>
        </div>

        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Client</th>
                <th>T√©l√©phone</th>
                <th>Module</th>
                <th>Plan</th>
                <th>Montant</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td colspan="8" style="text-align:center; padding:40px;">Chargement...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- MODULE BREAKDOWN -->
      <div class="card">
        <h2>üìä Analyse par Module</h2>
        <div id="moduleStats"></div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";
      
      const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const ADMIN_PHONE = "+221771342889";
      const ADMIN_PIN = "3435"; // Change √ßa fr√©rot!
      
      const $ = id => document.getElementById(id);
      let allData = [];
      let chartModules = null;
      let chartTimeline = null;

      // AUTH
      $("btnAuth").onclick = async function(){
        const phone = $("authPhone").value.trim();
        const pin = $("authPin").value.trim();
        
        if(phone !== ADMIN_PHONE || pin !== ADMIN_PIN){
          $("authError").textContent = "‚ùå Acc√®s refus√©!";
          return;
        }
        
        localStorage.setItem("digiy_dashboard_auth", "ok");
        showDashboard();
      };

      $("btnLogout").onclick = function(){
        localStorage.removeItem("digiy_dashboard_auth");
        location.reload();
      };

      // CHECK AUTH
      if(localStorage.getItem("digiy_dashboard_auth") === "ok"){
        showDashboard();
      }

      function showDashboard(){
        $("authBox").style.display = "none";
        $("dashboard").style.display = "block";
        loadData();
      }

      // LOAD DATA
      async function loadData(){
        $("loading").style.display = "block";
        
        try{
          const periode = $("filterPeriode").value;
          let query = sb.from("encaissements_digiylyfe").select("*").order("created_at", { ascending: false });
          
          if(periode !== "all"){
            const dateDebut = new Date();
            dateDebut.setDate(dateDebut.getDate() - parseInt(periode));
            query = query.gte("created_at", dateDebut.toISOString());
          }
          
          const result = await query;
          
          if(result.error) throw result.error;
          
          allData = result.data || [];
          renderAll();
          
        }catch(e){
          console.error(e);
          alert("Erreur chargement: " + e.message);
        }finally{
          $("loading").style.display = "none";
        }
      }

      function renderAll(){
        renderKPIs();
        renderTable();
        renderCharts();
        renderModuleStats();
      }

      function fmt(n){
        return Number(n||0).toLocaleString("fr-FR");
      }

      function renderKPIs(){
        const filtered = filterData();
        
        const total = filtered.reduce((sum, row) => sum + (row.montant||0), 0);
        const confirmes = filtered.filter(r => ["CONFIRME","ACTIF"].includes(r.statut)).length;
        const attente = filtered.filter(r => r.statut === "EN_ATTENTE").length;
        const mrr = filtered.filter(r => ["CONFIRME","ACTIF"].includes(r.statut)).reduce((sum, row) => sum + (row.montant||0), 0);
        
        $("kpiTotal").textContent = fmt(total) + " F";
        $("kpiConfirmes").textContent = confirmes;
        $("kpiAttente").textContent = attente;
        $("kpiMRR").textContent = fmt(mrr) + " F";
      }

      function renderTable(){
        const filtered = filterData();
        const tbody = $("tableBody");
        
        if(filtered.length === 0){
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px;">Aucun encaissement</td></tr>';
          return;
        }
        
        tbody.innerHTML = filtered.map(row => {
          const date = new Date(row.created_at).toLocaleDateString("fr-FR", {day:"2-digit", month:"short", year:"numeric"});
          const nom = [row.prenom, row.nom].filter(Boolean).join(" ") || "‚Äî";
          const statut = row.statut || "‚Äî";
          
          let badgeClass = "badge";
          if(["CONFIRME","ACTIF"].includes(statut)) badgeClass += " ok";
          else if(statut === "EN_ATTENTE") badgeClass += " warn";
          else if(statut === "ANNULE") badgeClass += " bad";
          
          return `
            <tr>
              <td>${date}</td>
              <td><b>${nom}</b></td>
              <td class="mono">${row.phone||"‚Äî"}</td>
              <td><b>${row.module}</b></td>
              <td class="small">${row.plan||"‚Äî"}</td>
              <td><b>${fmt(row.montant)} F</b></td>
              <td><span class="${badgeClass}">${statut}</span></td>
              <td class="small mono">${row.payment_id ? row.payment_id.slice(0,8)+"..." : "‚Äî"}</td>
            </tr>
          `;
        }).join("");
      }

      function renderCharts(){
        const filtered = filterData();
        
        // Chart Modules
        const moduleData = {};
        filtered.forEach(row => {
          const m = row.module || "AUTRE";
          moduleData[m] = (moduleData[m]||0) + (row.montant||0);
        });
        
        const moduleLabels = Object.keys(moduleData);
        const moduleValues = Object.values(moduleData);
        
        if(chartModules) chartModules.destroy();
        chartModules = new Chart($("chartModules"), {
          type: "doughnut",
          data: {
            labels: moduleLabels,
            datasets: [{
              data: moduleValues,
              backgroundColor: ["#22c55e","#facc15","#f59e0b","#ef4444","#3b82f6","#8b5cf6","#ec4899","#06b6d4"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "bottom", labels: { color: "#eafff1" } }
            }
          }
        });
        
        // Chart Timeline
        const timelineData = {};
        filtered.forEach(row => {
          const date = new Date(row.created_at).toLocaleDateString("fr-FR");
          timelineData[date] = (timelineData[date]||0) + (row.montant||0);
        });
        
        const timelineLabels = Object.keys(timelineData).slice(-14);
        const timelineValues = timelineLabels.map(d => timelineData[d]||0);
        
        if(chartTimeline) chartTimeline.destroy();
        chartTimeline = new Chart($("chartTimeline"), {
          type: "line",
          data: {
            labels: timelineLabels,
            datasets: [{
              label: "Encaissements (F CFA)",
              data: timelineValues,
              borderColor: "#22c55e",
              backgroundColor: "rgba(34,197,94,0.1)",
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: "#eafff1" } }
            },
            scales: {
              x: { ticks: { color: "#eafff1" }, grid: { color: "rgba(255,255,255,0.1)" } },
              y: { ticks: { color: "#eafff1" }, grid: { color: "rgba(255,255,255,0.1)" } }
            }
          }
        });
      }

      function renderModuleStats(){
        const filtered = filterData();
        const moduleStats = {};
        
        filtered.forEach(row => {
          const m = row.module || "AUTRE";
          if(!moduleStats[m]){
            moduleStats[m] = { count: 0, total: 0, actifs: 0 };
          }
          moduleStats[m].count++;
          moduleStats[m].total += (row.montant||0);
          if(["CONFIRME","ACTIF"].includes(row.statut)) moduleStats[m].actifs++;
        });
        
        const html = Object.entries(moduleStats).map(([module, stats]) => `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border:1px solid var(--line); border-radius:12px; margin:8px 0;">
            <div>
              <b style="font-size:16px;">${module}</b>
              <div class="small">${stats.count} abonnements ¬∑ ${stats.actifs} actifs</div>
            </div>
            <div style="text-align:right;">
              <b style="font-size:20px; color:var(--gold);">${fmt(stats.total)} F</b>
              <div class="small">MRR: ${fmt(stats.total / (stats.count||1))} F/mois</div>
            </div>
          </div>
        `).join("");
        
        $("moduleStats").innerHTML = html || '<p class="small">Aucune donn√©e</p>';
      }

      function filterData(){
        let data = allData;
        
        const statut = $("filterStatut").value;
        const module = $("filterModule").value;
        
        if(statut) data = data.filter(r => r.statut === statut);
        if(module) data = data.filter(r => r.module === module);
        
        return data;
      }

      // EVENTS
      $("btnRefresh").onclick = loadData;
      $("filterStatut").onchange = renderAll;
      $("filterModule").onchange = renderAll;
      $("filterPeriode").onchange = loadData;
    })();
  </script>
</body>
</html>

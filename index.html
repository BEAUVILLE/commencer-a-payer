<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY PRO â€¢ Paiement & Activation</title>
  <meta name="theme-color" content="#16a34a"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px; --shadow:0 18px 50px rgba(0,0,0,.35);
      --gold:#facc15;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1040px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    h1{ margin:0; font-size:20px; font-weight:1100; letter-spacing:.2px; }
    h2{ margin:0; font-size:16px; font-weight:1100; }
    p{ margin:8px 0 0; color:var(--muted); line-height:1.35; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid var(--line); border-radius:999px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .small{ font-size:13px; color:var(--muted); line-height:1.35; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    @media(min-width:960px){ .grid{ grid-template-columns:1.05fr .95fr; } }

    .statusBig{
      margin-top:12px; padding:12px; border-radius:16px;
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-weight:1100;
    }
    .statusBig.ok{ border-color: rgba(34,197,94,.55); }
    .statusBig.warn{ border-color: rgba(245,158,11,.55); }
    .statusBig.bad{ border-color: rgba(239,68,68,.55); }

    .tag{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .tag.ok{ color: var(--ok); border-color: rgba(34,197,94,.45); }
    .tag.warn{ color: var(--warn); border-color: rgba(245,158,11,.45); }
    .tag.bad{ color: var(--bad); border-color: rgba(239,68,68,.45); }

    .btn{
      border:1px solid var(--line); background:transparent; color:var(--text);
      padding:12px 14px; border-radius:16px; cursor:pointer; font-weight:1100;
      min-height:52px; width:100%;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.ok{ border-color: rgba(34,197,94,.55); }
    .btn.warn{ border-color: rgba(245,158,11,.55); }
    .btn.bad{ border-color: rgba(239,68,68,.55); }
    .btn.gold{ border-color: rgba(250,204,21,.65); }

    .box{ border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(0,0,0,.12); }
    .cards{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:720px){ .cards{ grid-template-columns:repeat(2,1fr); } }
    @media(min-width:1020px){ .cards{ grid-template-columns:repeat(2,1fr); } }

    .plan{
      border:1px solid var(--line); border-radius:16px; padding:12px;
      background:rgba(0,0,0,.10);
      display:flex; flex-direction:column; gap:10px;
    }
    .planHead{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted);
    }
    .badge.pop{ border-color:rgba(250,204,21,.55); color:var(--gold); }
    .price{ font-size:18px; font-weight:1200; }
    .list{ margin:0; padding-left:18px; color:var(--muted); font-size:13px; line-height:1.35; }
    .list li{ margin:4px 0; }
    .k{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
        font-size:12px; padding:2px 6px; border:1px solid var(--line); border-radius:8px; color:var(--muted);
        background:rgba(0,0,0,.12);
    }
    .actions2{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:560px){ .actions2{ grid-template-columns:1fr 1fr; } }

    .selectLine{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1>DIGIY PRO</h1>
          <p class="small"><b>0% Commission</b> Â· Paiement Direct</p>
        </div>
        <div class="row">
          <span class="pill">ğŸ“¦ module: <span class="mono" id="pillModule">â€”</span></span>
          <span class="pill">ğŸ“± phone: <span class="mono" id="pillPhone">â€”</span></span>
          <span class="pill">ğŸ·ï¸ slug: <span class="mono" id="pillSlug">â€”</span></span>
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <h2>â„¹ï¸ Paiement & Activation DIGIY</h2>
        <p class="small">Effectue d'abord le paiement via <b>Wave</b>, puis confirme sur <b>WhatsApp</b>. (Cette page sait revenir automatiquement au planning)</p>
      </div>

      <div class="statusBig warn" id="statusBig">
        <div id="statusText">â³ VÃ©rification du statutâ€¦</div>
        <span class="tag warn" id="tag">EN COURS</span>
      </div>

      <div class="grid">
        <!-- LEFT: Paiement + rÃ©sumÃ© -->
        <div class="box">
          <h2>ğŸ’³ Paiement via Wave</h2>
          <p class="small">Ouvre Wave et envoie le montant Ã  :</p>

          <div class="hr"></div>

          <div class="selectLine">
            <div>
              <div style="font-weight:1200;">ğŸ“± JB BEAUVILLE</div>
              <div class="mono" style="font-weight:1100;">+221 77 134 28 89</div>
              <div class="small">Montant = prix du module choisi</div>
            </div>
            <div class="pill">Montant: <span class="mono" id="pillAmount">â€”</span></div>
          </div>

          <div class="hr"></div>

          <h2>ğŸ’¬ Confirmation WhatsApp</h2>
          <p class="small">AprÃ¨s le paiement, envoie : âœ… le reÃ§u Wave âœ… le module/pack choisi</p>

          <div class="hr"></div>

          <div class="title" style="font-weight:1200;">ğŸ“Œ RÃ©sumÃ© automatique</div>
          <div class="small">
            ğŸ“¦ module: <span class="mono" id="sumModule">â€”</span><br/>
            ğŸ“± phone: <span class="mono" id="sumPhone">â€”</span><br/>
            ğŸ·ï¸ slug: <span class="mono" id="sumSlug">â€”</span><br/>
            ğŸ§¾ plan: <span class="mono" id="sumPlan">â€”</span><br/>
            ğŸ’° montant: <span class="mono" id="sumAmount">â€”</span>
          </div>

          <div class="hr"></div>

          <div class="actions2">
            <button class="btn gold" id="btnPayNow">âš¡ Payer maintenant (WhatsApp)</button>
            <button class="btn warn" id="btnIpaid">âœ… Jâ€™ai payÃ© (mettre EN ATTENTE)</button>
          </div>

          <div style="height:10px;"></div>

          <div class="actions2">
            <button class="btn warn" id="btnRefresh">ğŸ”„ RafraÃ®chir statut</button>
            <button class="btn ok" id="btnBack" disabled>âœ… Retour au planning</button>
          </div>

          <div style="height:10px;"></div>

          <button class="btn bad" id="btnHelp">ğŸ’¬ Support WhatsApp</button>

          <div class="small" id="hint" style="margin-top:10px;"></div>
        </div>

        <!-- RIGHT: Modules & tarifs -->
        <div class="box">
          <h2>Choisis ton module PRO ğŸ¦…</h2>
          <p class="small">Abonnement mensuel Â· 0% commission sur tes revenus Â· Tu gardes 100% de ce que tu gagnes</p>
          <p class="small">âœ“ Paiement direct Wave âœ“ Activation rapide âœ“ Made in SÃ©nÃ©gal</p>

          <div class="hr"></div>

          <h2>ğŸ§¾ DIGIY POS PRO â€” Caisse ConnectÃ©e</h2>
          <p class="small">GÃ¨re ta boutique comme un PRO Â· 0% commission</p>

          <div class="cards">
            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸ’› POS MENSUEL</div>
                  <div class="small">Ventes illimitÃ©es Â· Gestion stock Â· Historique Â· Support WhatsApp</div>
                </div>
                <span class="badge">Prix fixe</span>
              </div>
              <div class="price">12,900 F / mois</div>
              <button class="btn gold" data-choose="POS" data-plan="POS_MONTHLY" data-amount="12900">Choisir Mensuel</button>
            </div>

            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸ’š POS TRIMESTRIEL</div>
                  <div class="small">Tous avantages MENSUEL + formation incluse</div>
                </div>
                <span class="badge">Ã‰conomie 7%</span>
              </div>
              <div class="price">36,000 F (12,000/mois)</div>
              <button class="btn gold" data-choose="POS" data-plan="POS_QUARTER" data-amount="36000">Choisir Trimestriel</button>
            </div>

            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸ’™ POS SEMESTRIEL</div>
                  <div class="small">Formation personnalisÃ©e + Saisie 50 produits OFFERTE</div>
                </div>
                <span class="badge pop">â­ POPULAIRE</span>
              </div>
              <div class="price">68,000 F (11,333/mois)</div>
              <button class="btn gold" data-choose="POS" data-plan="POS_SEMESTER" data-amount="68000">Choisir Semestriel</button>
            </div>

            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸ’œ POS ANNUEL</div>
                  <div class="small">Saisie 50 produits + Formation 2h + Support dÃ©diÃ© inclus</div>
                </div>
                <span class="badge pop">ğŸ MEILLEURE OFFRE</span>
              </div>
              <div class="price">125,000 F (10,417/mois)</div>
              <button class="btn gold" data-choose="POS" data-plan="POS_YEAR" data-amount="125000">Choisir Annuel</button>
            </div>
          </div>

          <div class="hr"></div>

          <h2>ğŸ“¦ Autres modules individuels</h2>

          <div class="cards">
            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸš— DIGIY DRIVER</div>
                  <div class="small">VTC sans commission Â· Paiement direct aux chauffeurs</div>
                </div>
                <span class="badge">Prix fixe</span>
              </div>
              <div class="price">9,900 F / mois</div>
              <button class="btn gold" data-choose="DRIVER" data-plan="DRIVER_MONTHLY" data-amount="9900">Choisir DRIVER</button>
            </div>

            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸ  DIGIY LOC</div>
                  <div class="small">Location courte durÃ©e Â· Calendrier Â· RÃ©servations en ligne Â· 0% commission</div>
                </div>
                <span class="badge">Par logements</span>
              </div>
              <div class="small">
                1-5 logements : <b>9,900</b> F<br/>
                6-9 logements : <b>15,000</b> F<br/>
                10-20 logements : <b>25,000</b> F<br/>
                21-30 logements : <b>30,000</b> F<br/>
                30+ logements : <b>50,000</b> F
              </div>
              <div style="height:10px;"></div>
              <div class="row">
                <button class="btn gold" data-choose="LOC" data-plan="LOC_1_5" data-amount="9900">1â€“5</button>
                <button class="btn gold" data-choose="LOC" data-plan="LOC_6_9" data-amount="15000">6â€“9</button>
                <button class="btn gold" data-choose="LOC" data-plan="LOC_10_20" data-amount="25000">10â€“20</button>
                <button class="btn gold" data-choose="LOC" data-plan="LOC_21_30" data-amount="30000">21â€“30</button>
                <button class="btn gold" data-choose="LOC" data-plan="LOC_30P" data-amount="50000">30+</button>
              </div>
            </div>

            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸ›’ DIGIY MARKET</div>
                  <div class="small">Marketplace locale Â· Boutique en ligne Â· Gestion stock</div>
                </div>
                <span class="badge">Prix fixe</span>
              </div>
              <div class="price">12,900 F / mois</div>
              <button class="btn gold" data-choose="MARKET" data-plan="MARKET_MONTHLY" data-amount="12900">Choisir MARKET</button>
            </div>

            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸ’¼ DIGIY JOBS</div>
                  <div class="small">Emploi & recrutement Â· Offres Â· CV</div>
                </div>
                <span class="badge">Prix fixe</span>
              </div>
              <div class="price">7,900 F / mois</div>
              <button class="btn gold" data-choose="JOBS" data-plan="JOBS_MONTHLY" data-amount="7900">Choisir JOBS</button>
            </div>

            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸ—ï¸ DIGIY BUILD</div>
                  <div class="small">Services construction Â· Devis Â· Planning</div>
                </div>
                <span class="badge">Prix fixe</span>
              </div>
              <div class="price">9,900 F / mois</div>
              <button class="btn gold" data-choose="BUILD" data-plan="BUILD_MONTHLY" data-amount="9900">Choisir BUILD</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="small">Â© DIGIYLYFE â€” Made in SÃ©nÃ©gal ğŸ‡¸ğŸ‡³ Â· 0% commission Â· Paiement direct Â· SouverainetÃ© digitale</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // =============================
      // SUPABASE (statut)
      // =============================
      const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdXNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const SUPPORT_WA = "+221771342889"; // JB BEAUVILLE
      const $ = (id)=>document.getElementById(id);

      function qs(name){
        try{ return new URL(location.href).searchParams.get(name) || ""; }catch(_){ return ""; }
      }
      function setQS(name, value){
        const u = new URL(location.href);
        if(value === null || value === undefined || value === "") u.searchParams.delete(name);
        else u.searchParams.set(name, value);
        history.replaceState({}, "", u.toString());
      }
      function fmt(n){
        n = Number(n||0);
        return n.toLocaleString("fr-FR");
      }

      // Params from guard
      const from = (qs("from") || "").trim();
      const slug = (qs("slug") || "").trim();
      const phone = (qs("phone") || "").trim();
      // module (if guard sends LOC) else â€”
      let module = (qs("module") || "").trim();
      let status = (qs("status") || "").trim().toLowerCase(); // pending etc

      // Selected choice
      let chosenModule = (qs("m") || module || "").trim(); // allow m=...
      let chosenPlan = (qs("plan") || "").trim();
      let chosenAmount = (qs("amount") || "").trim();

      // UI init
      $("pillModule").textContent = chosenModule || "â€”";
      $("pillPhone").textContent = phone || "â€”";
      $("pillSlug").textContent = slug || "â€”";

      $("sumModule").textContent = chosenModule || "â€”";
      $("sumPhone").textContent = phone || "â€”";
      $("sumSlug").textContent = slug || "â€”";
      $("sumPlan").textContent = chosenPlan || "â€”";
      $("sumAmount").textContent = chosenAmount ? (fmt(chosenAmount) + " F") : "â€”";
      $("pillAmount").textContent = chosenAmount ? (fmt(chosenAmount) + " F") : "â€”";

      function setHint(msg){ $("hint").textContent = msg || ""; }
      function setBig(text, tone, tagText){
        const el = $("statusBig");
        el.className = "statusBig " + (tone || "warn");
        $("statusText").textContent = text;
        const tag = $("tag");
        tag.className = "tag " + (tone || "warn");
        tag.textContent = tagText || "â€”";
      }

      function safeBack(){
        if(from){ location.replace(from); return; }
        // fallback: login LOC PRO
        location.replace("https://beauville.github.io/digiy-loc-pro/login.html" + (slug ? "?slug="+encodeURIComponent(slug) : ""));
      }

      function wa(msg){
        location.href = "https://wa.me/" + SUPPORT_WA.replace(/\+/g,"") + "?text=" + encodeURIComponent(msg);
      }

      function ensureChoice(){
        if(!phone){
          setHint("âš ï¸ TÃ©lÃ©phone manquant. Cette page doit recevoir ?phone=+221... via le guard.");
          return false;
        }
        if(!chosenModule){
          setHint("âš ï¸ Choisis un module (bouton â€˜Choisirâ€™).");
          return false;
        }
        if(!chosenAmount){
          setHint("âš ï¸ Choisis un tarif (montant).");
          return false;
        }
        return true;
      }

      function pick(mod, plan, amount){
        chosenModule = String(mod||"").trim().toUpperCase();
        chosenPlan = String(plan||"").trim();
        chosenAmount = String(amount||"").trim();

        // persist in URL for share/reload
        setQS("m", chosenModule);
        setQS("plan", chosenPlan);
        setQS("amount", chosenAmount);

        $("pillModule").textContent = chosenModule || "â€”";
        $("sumModule").textContent = chosenModule || "â€”";
        $("sumPlan").textContent = chosenPlan || "â€”";
        $("sumAmount").textContent = chosenAmount ? (fmt(chosenAmount) + " F") : "â€”";
        $("pillAmount").textContent = chosenAmount ? (fmt(chosenAmount) + " F") : "â€”";

        // If guard didn't provide module, set module for status check to chosenModule
        module = chosenModule;

        setHint("âœ… Choix enregistrÃ©. Clique â€œPayer maintenantâ€.");
      }

      document.querySelectorAll("[data-choose]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          pick(btn.getAttribute("data-choose"), btn.getAttribute("data-plan"), btn.getAttribute("data-amount"));
        });
      });

      $("btnPayNow").onclick = ()=>{
        if(!ensureChoice()) return;

        const msg =
`DIGIY PRO â€¢ Paiement Wave

BÃ©nÃ©ficiaire: JB BEAUVILLE
Wave/WhatsApp: ${SUPPORT_WA}

ğŸ“¦ Module: ${chosenModule}
ğŸ§¾ Plan: ${chosenPlan || "â€”"}
ğŸ’° Montant: ${fmt(chosenAmount)} F CFA
ğŸ“± TÃ©lÃ©phone: ${phone || "â€”"}
ğŸ·ï¸ Slug: ${slug || "â€”"}

Je paie via Wave maintenant.
Merci de confirmer et dâ€™activer aprÃ¨s rÃ©ception du paiement.

â€” DIGIY`;
        wa(msg);
      };

      $("btnIpaid").onclick = ()=>{
        if(!ensureChoice()) return;

        status = "pending";
        setQS("status", "pending");
        setBig("ğŸŸ  Paiement signalÃ©. Activation en cours.", "warn", "EN ATTENTE");
        setHint("Envoie le reÃ§u Wave sur WhatsApp. Puis clique â€˜RafraÃ®chir statutâ€™.");

        const msg =
`DIGIY PRO â€¢ Confirmation paiement

ğŸ“¦ Module: ${chosenModule}
ğŸ§¾ Plan: ${chosenPlan || "â€”"}
ğŸ’° Montant: ${fmt(chosenAmount)} F CFA
ğŸ“± TÃ©lÃ©phone: ${phone || "â€”"}
ğŸ·ï¸ Slug: ${slug || "â€”"}

Je viens de payer via Wave.
Je joins le reÃ§u ici.

Merci. â€” DIGIY`;
        wa(msg);
      };

      $("btnHelp").onclick = ()=>{
        const msg =
`DIGIY PRO â€¢ Support

ğŸ“¦ Module: ${chosenModule || module || "â€”"}
ğŸ§¾ Plan: ${chosenPlan || "â€”"}
ğŸ’° Montant: ${chosenAmount ? (fmt(chosenAmount)+" F") : "â€”"}
ğŸ“± TÃ©lÃ©phone: ${phone || "â€”"}
ğŸ·ï¸ Slug: ${slug || "â€”"}
Statut page: ${status || "â€”"}

Merci. â€” DIGIY`;
        wa(msg);
      };

      $("btnBack").onclick = safeBack;

      $("btnRefresh").onclick = ()=> checkStatus(true);

      async function checkStatus(manual){
        $("btnRefresh").disabled = true;
        setHint("");

        if(status === "pending"){
          setBig("ğŸŸ  Paiement en attente de validation.", "warn", "EN ATTENTE");
        }else{
          setBig("â³ VÃ©rification du statutâ€¦", "warn", "EN COURS");
        }

        if(!phone){
          setBig("ğŸ”´ TÃ©lÃ©phone manquant (URL incomplÃ¨te).", "bad", "INACTIF");
          setHint("On attend ?phone=+221... (envoyÃ© par le guard).");
          $("btnBack").disabled = true;
          $("btnRefresh").disabled = false;
          return;
        }

        // Module Ã  checker : celui du guard sinon celui choisi
        const m = (module || chosenModule || "LOC").toUpperCase();

        // Si pending (manuel), on laisse le recheck possible (peut passer actif)
        try{
          const { data, error } = await sb.rpc("is_module_active", { p_phone: phone, p_module: m });
          if(error) throw error;

          const active = !!data;

          if(active){
            setQS("status", "active");
            status = "active";
            setBig("ğŸŸ¢ Abonnement ACTIF. AccÃ¨s ouvert.", "ok", "ACTIF");
            setHint("Tu peux revenir au planning maintenant.");
            $("btnBack").disabled = false;
          }else{
            if(status === "pending"){
              setBig("ğŸŸ  Paiement EN ATTENTE (pas encore activÃ©).", "warn", "EN ATTENTE");
              setHint("Si tu as envoyÃ© la preuve Wave, Ã§a va passer ACTIF aprÃ¨s validation.");
              $("btnBack").disabled = true;
            }else{
              setBig("ğŸ”´ Abonnement INACTIF. Paiement requis.", "bad", "INACTIF");
              setHint("Choisis un module + tarif, puis clique â€œPayer maintenantâ€.");
              $("btnBack").disabled = true;
            }
          }
        }catch(e){
          console.error(e);
          setBig("ğŸ”´ Erreur vÃ©rification statut.", "bad", "ERREUR");
          setHint("Supabase/RPC: " + String(e?.message || e));
          $("btnBack").disabled = true;
        }finally{
          $("btnRefresh").disabled = false;
        }
      }

      // Auto-check
      checkStatus(false);
    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>COMMENCER √Ä PAYER ‚Äî DIGIYLYFE</title>
  <meta name="theme-color" content="#16a34a"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --gold:#facc15;
      --radius:18px; --shadow:0 18px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:720px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); }
    h1{ margin:0; font-size:20px; font-weight:1100; }
    p{ margin:8px 0 0; color:var(--muted); line-height:1.4; }
    .hr{ height:1px; background:var(--line); margin:14px 0; }

    .status{
      padding:12px; border-radius:16px; border:1px solid var(--line);
      font-weight:1000; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .status.ok{ border-color: rgba(34,197,94,.55); }
    .status.warn{ border-color: rgba(245,158,11,.55); }
    .status.bad{ border-color: rgba(239,68,68,.55); }

    .tag{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .tag.ok{ color: var(--ok); border-color: rgba(34,197,94,.45); }
    .tag.warn{ color: var(--warn); border-color: rgba(245,158,11,.45); }
    .tag.bad{ color: var(--bad); border-color: rgba(239,68,68,.45); }

    .btn{
      width:100%; min-height:52px; border-radius:16px; cursor:pointer;
      border:1px solid var(--line); background:transparent; color:var(--text);
      padding:12px 14px; font-weight:1100;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.ok{ border-color: rgba(34,197,94,.55); }
    .btn.warn{ border-color: rgba(245,158,11,.55); }
    .btn.bad{ border-color: rgba(239,68,68,.55); }
    .btn.gold{ border-color: rgba(250,204,21,.65); }

    .box{ border:1px solid var(--line); border-radius:16px; padding:14px; background:rgba(0,0,0,.12); }
    .steps{ margin:0; padding-left:18px; color:var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:220px; }
    .small{ font-size:13px; color:var(--muted); line-height:1.35; }
    .hide{ display:none; }

    /* Lang switch (top) */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .lang-switch{
      display:flex;
      gap:6px;
      padding:4px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.08);
    }
    .lang-switch button{
      border:none;
      padding:7px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:1100;
      font-size:12px;
      background:transparent;
      color:var(--text);
    }
    .lang-switch button.active{
      background:#0f172a;
      color:#fff;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="topbar">
        <div class="lang-switch" aria-label="Language switch">
          <button id="lang-fr" class="active" type="button">FR</button>
          <button id="lang-wo" type="button">WO</button>
        </div>
        <span class="tag" data-i18n="tag_digiy">DIGIY PAY</span>
      </div>

      <h1 data-i18n="page_title">COMMENCER √Ä PAYER ‚Äî DIGIYLYFE</h1>
      <p class="small" data-i18n="subtitle">0% commission ¬∑ Paiement Wave ¬∑ Activation DIGIY</p>

      <div class="hr"></div>

      <div class="status warn" id="statusBox">
        <div id="statusText" data-i18n="status_preparing">‚è≥ Pr√©paration‚Ä¶</div>
        <span class="tag warn" id="statusTag" data-i18n="tag_in_progress">EN COURS</span>
      </div>

      <div class="hr"></div>

      <!-- TOKEN MODE -->
      <div class="box" id="tokenBox">
        <h2 style="margin:0;font-size:16px;font-weight:1100;" data-i18n="token_title">üîê Activation s√©curis√©e</h2>
        <p class="small" data-i18n="token_desc">Si tu as re√ßu un lien DIGIY avec token, clique simplement.</p>

        <div class="hr"></div>

        <button class="btn ok" id="btnActivateToken">
          <span data-i18n="btn_activate_now">‚úÖ Activer maintenant</span>
          <span id="spinnerToken" class="mono" style="display:none;margin-left:8px;">‚è≥</span>
        </button>

        <p class="small" id="tokenHint" style="margin-top:10px;"></p>
      </div>

      <div class="hr"></div>

      <!-- MANUAL MODE -->
      <div class="box" id="manualBox">
        <h2 style="margin:0;font-size:16px;font-weight:1100;" data-i18n="manual_title">üí≥ Paiement manuel (Wave)</h2>
        <p class="small" data-i18n="manual_desc">Paye sur Wave, puis envoie le re√ßu sur WhatsApp. On active ensuite.</p>

        <div class="hr"></div>

        <div class="row">
          <div>
            <div style="font-weight:1100;" data-i18n="beneficiary">B√©n√©ficiaire</div>
            <div class="mono" style="font-weight:1000;">JB BEAUVILLE</div>
          </div>
          <div>
            <div style="font-weight:1100;" data-i18n="wave_number">Num√©ro Wave</div>
            <div class="mono" style="font-weight:1000;" id="waveTo">+221 77 134 28 89</div>
          </div>
        </div>

        <div class="hr"></div>

        <ol class="steps" id="stepsList">
          <li data-i18n="step_1">Fais le transfert Wave</li>
          <li data-i18n="step_2">Envoie le re√ßu sur WhatsApp</li>
          <li data-i18n="step_3">Retourne au module (activation apr√®s validation)</li>
        </ol>

        <div class="hr"></div>

        <div class="row">
          <button class="btn gold" id="btnWaConfirm" data-i18n="btn_wa_confirm">üí¨ Confirmer WhatsApp (avec re√ßu)</button>
          <button class="btn bad" id="btnSupport" data-i18n="btn_support">üõü Support WhatsApp</button>
        </div>

        <p class="small" id="manualHint" style="margin-top:10px;"></p>
      </div>

      <!-- Debug cach√© (si tu veux garder) -->
      <div class="hide" id="dbg"></div>
    </div>
  </div>

  <script>
  (function(){
    "use strict";

    /* =========================
       i18n ‚Äî FR / WO (Wolof)
       ========================= */
    const DIGIY_LANG = {
      fr: {
        tag_digiy: "DIGIY PAY",
        page_title: "COMMENCER √Ä PAYER ‚Äî DIGIYLYFE",
        subtitle: "0% commission ¬∑ Paiement Wave ¬∑ Activation DIGIY",

        status_preparing: "‚è≥ Pr√©paration‚Ä¶",
        tag_in_progress: "EN COURS",

        token_title: "üîê Activation s√©curis√©e",
        token_desc: "Si tu as re√ßu un lien DIGIY avec token, clique simplement.",
        btn_activate_now: "‚úÖ Activer maintenant",

        manual_title: "üí≥ Paiement manuel (Wave)",
        manual_desc: "Paye sur Wave, puis envoie le re√ßu sur WhatsApp. On active ensuite.",
        beneficiary: "B√©n√©ficiaire",
        wave_number: "Num√©ro Wave",

        step_1: "Fais le transfert Wave",
        step_2: "Envoie le re√ßu sur WhatsApp",
        step_3: "Retourne au module (activation apr√®s validation)",

        btn_wa_confirm: "üí¨ Confirmer WhatsApp (avec re√ßu)",
        btn_support: "üõü Support WhatsApp",

        hint_manual_no_token: "Astuce : apr√®s envoi du re√ßu, l‚Äôactivation se fait rapidement.",
        hint_after_send: "Apr√®s activation, retourne sur ton module.",

        // status dynamic
        s_manual: "üí≥ Paiement Wave : confirme sur WhatsApp avec le re√ßu.",
        t_manual: "MANUEL",

        s_token_detected: "üîê Lien s√©curis√© d√©tect√©. Clique pour activer.",
        t_token: "TOKEN",

        s_token_running: "‚è≥ Activation s√©curis√©e en cours‚Ä¶",
        t_running: "EN COURS",

        s_token_ok: "üü¢ Activ√© ! Tu peux continuer.",
        t_active: "ACTIF",

        s_token_fail: "üî¥ Activation impossible. Contacte le support.",
        t_error: "ERREUR",

        s_wa_ready: "‚úÖ Message WhatsApp pr√™t. Ajoute le re√ßu.",
        t_wait: "EN ATTENTE",

        s_support: "üí¨ Support WhatsApp‚Ä¶",
        t_info: "INFO",

        token_hint_detected: "Token d√©tect√©. Activation en 1 clic.",
        token_hint_ok_close: "Activation OK. Tu peux fermer cette page.",

        alert_missing_token: "Token manquant."
      },

      wo: {
        tag_digiy: "DIGIY PAY",
        page_title: "TAMBALI FEY ‚Äî DIGIYLYFE",
        subtitle: "0% commission ¬∑ Fey Wave ¬∑ Activation DIGIY",

        status_preparing: "‚è≥ Di waajal‚Ä¶",
        tag_in_progress: "CI DIGGANTE",

        token_title: "üîê Activation bu am kaarange",
        token_desc: "Su fekkee nga jot na link DIGIY ak token, klik rekk.",
        btn_activate_now: "‚úÖ Tambali activation",

        manual_title: "üí≥ Fey bu manual (Wave)",
        manual_desc: "Fey ci Wave, te y√≥nnee re√ßu bi ci WhatsApp. Nu aktiv√© gannaaw.",
        beneficiary: "Boroom jot",
        wave_number: "Nimero Wave",

        step_1: "Def transfert Wave",
        step_2: "Y√≥nnee re√ßu bi ci WhatsApp",
        step_3: "Dellu ci module bi (activation gannaaw nangu)",

        btn_wa_confirm: "üí¨ D√´ggal WhatsApp (ak re√ßu)",
        btn_support: "üõü Support WhatsApp",

        hint_manual_no_token: "Xelal : gannaaw nga y√≥nnee re√ßu bi, activation bi dina gaaw.",
        hint_after_send: "Gannaaw activation, dellu ci sa module.",

        // status dynamic
        s_manual: "üí≥ Fey Wave : d√´ggal ci WhatsApp ak re√ßu bi.",
        t_manual: "MANUAL",

        s_token_detected: "üîê Link bu kaarange am na. Klik ngir aktiv√©.",
        t_token: "TOKEN",

        s_token_running: "‚è≥ Activation bi ci yoon la‚Ä¶",
        t_running: "CI DIGGANTE",

        s_token_ok: "üü¢ Aktiv√© na ! M√´n nga kontinye.",
        t_active: "AKTIF",

        s_token_fail: "üî¥ Activation bi m√´nu. Jokkoo ak support.",
        t_error: "NJ UUMTE",

        s_wa_ready: "‚úÖ WhatsApp message bi diyaar na. Yokk re√ßu bi.",
        t_wait: "DI XAAR",

        s_support: "üí¨ Support WhatsApp‚Ä¶",
        t_info: "INFO",

        token_hint_detected: "Token bi am na. Activation 1 klik.",
        token_hint_ok_close: "Activation OK. M√´n nga t√´j page bi.",

        alert_missing_token: "Token bi amul."
      }
    };

    let CURRENT_LANG = localStorage.getItem("digiy_lang") || "fr";

    function t(key, ...args){
      const pack = DIGIY_LANG[CURRENT_LANG] || DIGIY_LANG.fr;
      const val = pack[key];
      if (typeof val === "function") return val(...args);
      return (val != null) ? String(val) : String((DIGIY_LANG.fr[key] ?? key));
    }

    function applyLanguage(lang){
      CURRENT_LANG = (lang === "wo") ? "wo" : "fr";
      localStorage.setItem("digiy_lang", CURRENT_LANG);
      document.documentElement.setAttribute("lang", CURRENT_LANG === "wo" ? "wo" : "fr");

      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const key = el.dataset.i18n;
        const val = t(key);
        if (val) el.textContent = val;
      });

      document.getElementById("lang-fr")?.classList.toggle("active", CURRENT_LANG==="fr");
      document.getElementById("lang-wo")?.classList.toggle("active", CURRENT_LANG==="wo");
    }

    document.getElementById("lang-fr").addEventListener("click", ()=>{ applyLanguage("fr"); });
    document.getElementById("lang-wo").addEventListener("click", ()=>{ applyLanguage("wo"); });

    // === CONFIG SUPABASE (TES VALEURS) ===
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // WhatsApp
    const SUPPORT_WA = "+221771342889";
    const WAVE_TO = "+221771342889"; // affichage + message (mets 771342889 ou num√©ro que tu veux)

    const $ = (id)=>document.getElementById(id);
    const qp = new URLSearchParams(location.search);

    function setStatus(text, tone, tag){
      const box = $("statusBox");
      box.className = "status " + (tone || "warn");
      $("statusText").textContent = text || "";
      const tg = $("statusTag");
      tg.className = "tag " + (tone || "warn");
      tg.textContent = tag || "‚Äî";
    }

    function wa(msg){
      const num = SUPPORT_WA.replace(/\+/g,"");
      location.href = "https://wa.me/" + num + "?text=" + encodeURIComponent(msg);
    }

    function normPhone(p){
      p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
      if(p.startsWith("00221")) p = "+221" + p.slice(5);
      if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
      if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
      return p;
    }

    // === INPUTS URL (optionnels) ===
    const token = (qp.get("token") || "").trim();
    const ret = (qp.get("return") || "").trim();
    const auto = (qp.get("auto") === "1");

    const phone = normPhone(qp.get("phone") || "");
    const kind = (qp.get("kind") || "").trim().toLowerCase();
    const m = (qp.get("m") || "").trim();
    const plan = (qp.get("plan") || "").trim();
    const amount = (qp.get("amount") || "").toString().replace(/[^\d]/g,"");
    const slug = (qp.get("slug") || "").trim();
    const access = (qp.get("module") || "").trim().toUpperCase();
    const from = (qp.get("from") || "").trim();

    // UI
    $("waveTo").textContent = "+221 77 134 28 89";

    // init language ASAP
    applyLanguage(CURRENT_LANG);

    // --- TOKEN MODE visibility ---
    if(!token){
      $("tokenBox").classList.add("hide");
      setStatus(t("s_manual"), "warn", t("t_manual"));
      $("manualHint").textContent = t("hint_manual_no_token");
    } else {
      setStatus(t("s_token_detected"), "ok", t("t_token"));
      $("tokenHint").textContent = t("token_hint_detected");
    }

    // --- Activate token ---
    async function activateToken(){
      if(!token){
        alert(t("alert_missing_token"));
        return;
      }
      $("btnActivateToken").disabled = true;
      $("spinnerToken").style.display = "inline-block";
      setStatus(t("s_token_running"), "warn", t("t_running"));

      try{
        const { data, error } = await sb.rpc("digiy_pay_activate_token", { p_token: token });
        if(error) throw error;
        if(!data?.ok) throw new Error(data?.reason || "activation_failed");

        setStatus(t("s_token_ok"), "ok", t("t_active"));

        // redirect
        if(ret){
          const u = new URL(ret, location.origin);
          u.searchParams.set("from", "digiy-pay-token");
          location.href = u.toString();
        } else {
          $("tokenHint").textContent = t("token_hint_ok_close");
        }
      } catch(e){
        console.error(e);
        setStatus(t("s_token_fail"), "bad", t("t_error"));
        $("tokenHint").textContent = String(e.message || e);
      } finally {
        $("spinnerToken").style.display = "none";
        $("btnActivateToken").disabled = false;
      }
    }

    $("btnActivateToken").addEventListener("click", activateToken);

    if(auto && token){
      setTimeout(activateToken, 400);
    }

    // --- WhatsApp confirm (manual) ---
    $("btnWaConfirm").addEventListener("click", function(){
      let msg = (CURRENT_LANG === "wo")
        ? "DIGIY ‚Äî D√´ggal fey Wave\n\n"
        : "DIGIY ‚Äî Confirmation paiement Wave\n\n";

      msg += (CURRENT_LANG === "wo") ? "Boroom jot: JB BEAUVILLE\n" : "B√©n√©ficiaire: JB BEAUVILLE\n";
      msg += "Wave: " + WAVE_TO + "\n\n";
      if(phone) msg += (CURRENT_LANG === "wo" ? "T√©l√©phone: " : "T√©l√©phone: ") + phone + "\n";
      if(access) msg += (CURRENT_LANG === "wo" ? "Acc√®s: " : "Acc√®s: ") + access + "\n";
      if(kind) msg += (CURRENT_LANG === "wo" ? "Type: " : "Type: ") + kind + "\n";
      if(m) msg += (CURRENT_LANG === "wo" ? "Produit: " : "Produit: ") + m + "\n";
      if(plan) msg += (CURRENT_LANG === "wo" ? "Plan: " : "Plan: ") + plan + "\n";
      if(amount) msg += (CURRENT_LANG === "wo" ? "Montant: " : "Montant: ") + amount + " FCFA\n";
      if(slug) msg += "Slug: " + slug + "\n";
      if(token) msg += "Token: " + token + "\n";

      msg += (CURRENT_LANG === "wo")
        ? "\nDinaa y√≥nnee re√ßu Wave bi fii.\nJ√´r√´j√´f, aktiv√© leen. ‚Äî DIGIY"
        : "\nJe joins le re√ßu Wave ici.\nMerci d'activer. ‚Äî DIGIY";

      wa(msg);
      setStatus(t("s_wa_ready"), "warn", t("t_wait"));
    });

    $("btnSupport").addEventListener("click", function(){
      let msg = (CURRENT_LANG === "wo")
        ? "DIGIY ‚Äî Support Fey\n\n"
        : "DIGIY ‚Äî Support Paiement\n\n";

      if(phone) msg += "T√©l√©phone: " + phone + "\n";
      if(m) msg += "Produit: " + m + "\n";
      if(plan) msg += "Plan: " + plan + "\n";
      if(amount) msg += "Montant: " + amount + " FCFA\n";
      if(slug) msg += "Slug: " + slug + "\n";

      msg += (CURRENT_LANG === "wo")
        ? "\nDama soxla ndimbal. ‚Äî DIGIY"
        : "\nJ'ai besoin d'aide. ‚Äî DIGIY";

      wa(msg);
      setStatus(t("s_support"), "warn", t("t_info"));
    });

    if(from){
      $("manualHint").textContent = t("hint_after_send");
    }
  })();
  </script>
</body>
</html>

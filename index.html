<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY PRO â€¢ Paiement & Activation</title>
  <meta name="theme-color" content="#16a34a"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px; --shadow:0 18px 50px rgba(0,0,0,.35);
      --gold:#facc15;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    h1{ margin:0; font-size:20px; font-weight:1100; letter-spacing:.2px; }
    h2{ margin:0; font-size:16px; font-weight:1100; }
    p{ margin:8px 0 0; color:var(--muted); line-height:1.35; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid var(--line); border-radius:999px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .small{ font-size:13px; color:var(--muted); line-height:1.35; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    @media(min-width:980px){ .grid{ grid-template-columns:1.03fr .97fr; } }

    .statusBig{
      margin-top:12px; padding:12px; border-radius:16px;
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-weight:1100;
    }
    .statusBig.ok{ border-color: rgba(34,197,94,.55); }
    .statusBig.warn{ border-color: rgba(245,158,11,.55); }
    .statusBig.bad{ border-color: rgba(239,68,68,.55); }

    .tag{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .tag.ok{ color: var(--ok); border-color: rgba(34,197,94,.45); }
    .tag.warn{ color: var(--warn); border-color: rgba(245,158,11,.45); }
    .tag.bad{ color: var(--bad); border-color: rgba(239,68,68,.45); }

    .btn{
      border:1px solid var(--line); background:transparent; color:var(--text);
      padding:12px 14px; border-radius:16px; cursor:pointer; font-weight:1100;
      min-height:52px; width:100%;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.ok{ border-color: rgba(34,197,94,.55); }
    .btn.warn{ border-color: rgba(245,158,11,.55); }
    .btn.bad{ border-color: rgba(239,68,68,.55); }
    .btn.gold{ border-color: rgba(250,204,21,.65); }

    .box{ border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(0,0,0,.12); }
    .cards{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:740px){ .cards{ grid-template-columns:repeat(2,1fr); } }

    .plan{
      border:1px solid var(--line); border-radius:16px; padding:12px;
      background:rgba(0,0,0,.10);
      display:flex; flex-direction:column; gap:10px;
    }
    .planHead{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted);
      white-space:nowrap;
    }
    .badge.pop{ border-color:rgba(250,204,21,.55); color:var(--gold); }
    .price{ font-size:18px; font-weight:1200; }
    .list{ margin:0; padding-left:18px; color:var(--muted); font-size:13px; line-height:1.35; }
    .list li{ margin:4px 0; }
    .actions2{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:560px){ .actions2{ grid-template-columns:1fr 1fr; } }

    .selectLine{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .k{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
        font-size:12px; padding:2px 6px; border:1px solid var(--line); border-radius:8px; color:var(--muted);
        background:rgba(0,0,0,.12);
    }

    .qr-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .qr-container {
      background: #fff;
      border-radius: 24px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .qr-container h2 { color: #000; margin: 0 0 20px; font-size: 24px; }
    .qr-image {
      width: 300px; height: 300px; margin: 20px auto;
      border: 3px solid #22c55e; border-radius: 16px; padding: 10px; background: #fff;
    }
    .qr-amount { font-size: 36px; font-weight: 900; color: #facc15; margin: 20px 0; }
    .qr-details { color: #666; font-size: 14px; margin: 10px 0; font-weight: 900; }
    .qr-status { background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 15px; margin: 20px 0; }
    .qr-status-text { color: #16a34a; font-weight: 900; font-size: 16px; }
    .qr-status-sub { color: #666; font-size: 12px; margin-top: 5px; }
    .qr-btn-close {
      width: 100%; padding: 15px; background: #ef4444; color: #fff;
      border: none; border-radius: 12px; font-weight: 900; cursor: pointer; font-size: 16px; margin-top: 10px;
    }
    .qr-btn-close:hover { background: #dc2626; }
    .qr-instructions {
      background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px;
      padding: 15px; margin: 15px 0; color: #92400e; font-weight: 900; font-size: 13px;
    }

    input[type="text"], input[type="email"] {
      padding: 14px; border: 1px solid var(--line); border-radius: 12px;
      background: rgba(0,0,0,.12); color: var(--text); font-size: 15px; font-weight: 500; width: 100%;
    }
    input[type="text"]:focus, input[type="email"]:focus { outline: none; border-color: var(--ok); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1>DIGIY PRO</h1>
          <p class="small"><b>0% Commission</b> Â· Paiement Direct</p>
        </div>
        <div class="row">
          <span class="pill">ğŸ“¦ accÃ¨s: <span class="mono" id="pillAccess">â€”</span></span>
          <span class="pill">ğŸ“¦ choisi: <span class="mono" id="pillModule">â€”</span></span>
          <span class="pill">ğŸ“± phone: <span class="mono" id="pillPhone">â€”</span></span>
          <span class="pill">ğŸ·ï¸ slug: <span class="mono" id="pillSlug">â€”</span></span>
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <h2>â„¹ï¸ Paiement & Activation DIGIY</h2>
        <p class="small">
          Effectue d'abord le paiement via <b>Wave</b>, puis confirme sur <b>WhatsApp</b>.
          (Cette page sait revenir automatiquement au planning)
        </p>
      </div>

      <div class="statusBig warn" id="statusBig">
        <div id="statusText">â³ VÃ©rification du statutâ€¦</div>
        <span class="tag warn" id="tag">EN COURS</span>
      </div>

      <!-- ğŸ‘¤ SECTION INFOS CLIENT -->
      <div class="card" id="clientInfoBox" style="margin-top:16px; display:none;">
        <h2>ğŸ‘¤ Tes informations</h2>
        <p class="small">Pour bien enregistrer ton abonnement dans la caisse DIGIYLYFE</p>

        <div class="hr"></div>

        <div style="display:grid; gap:12px;">
          <input type="text" id="inputPrenom" placeholder="PrÃ©nom *">
          <input type="text" id="inputNom" placeholder="Nom *">
          <input type="email" id="inputEmail" placeholder="Email (optionnel)">
        </div>

        <div class="hr"></div>

        <button class="btn ok" id="btnSaveInfo">âœ… Valider mes infos</button>

        <p class="small" style="margin-top:8px; color:var(--muted);">
          * Champs obligatoires Â· Ces infos sont enregistrÃ©es pour ton abonnement
        </p>
      </div>

      <div class="grid">
        <div class="box">
          <h2>ğŸ’³ Paiement via Wave</h2>
          <p class="small">Scanne le QR avec ton app Wave :</p>

          <div class="hr"></div>

          <div class="selectLine">
            <div>
              <div style="font-weight:1200;">ğŸ“± JB BEAUVILLE</div>
              <div class="mono" style="font-weight:1100;">+221 77 134 28 89</div>
              <div class="small">Montant = prix du module choisi</div>
            </div>
            <div class="pill">Montant: <span class="mono" id="pillAmount">â€”</span></div>
          </div>

          <div class="hr"></div>

          <h2>ğŸ’¬ Confirmation WhatsApp</h2>
          <p class="small">AprÃ¨s le paiement, envoie : âœ… le reÃ§u Wave âœ… le module/pack choisi</p>

          <div class="hr"></div>

          <div style="font-weight:1200;">ğŸ“Œ RÃ©sumÃ© automatique</div>
          <div class="small">
            ğŸ“¦ accÃ¨s: <span class="mono" id="sumAccess">â€”</span><br/>
            ğŸ“¦ module: <span class="mono" id="sumModule">â€”</span><br/>
            ğŸ“± phone: <span class="mono" id="sumPhone">â€”</span><br/>
            ğŸ·ï¸ slug: <span class="mono" id="sumSlug">â€”</span><br/>
            ğŸ§¾ plan: <span class="mono" id="sumPlan">â€”</span><br/>
            ğŸ’° montant: <span class="mono" id="sumAmount">â€”</span>
          </div>

          <div class="hr"></div>

          <div class="actions2">
            <button class="btn gold" id="btnPayNow">âš¡ Payer maintenant (Wave QR)</button>
            <button class="btn warn" id="btnWaConfirm">ğŸ’¬ Confirmer sur WhatsApp</button>
          </div>

          <div style="height:10px;"></div>

          <div class="actions2">
            <button class="btn warn" id="btnRefresh">ğŸ”„ RafraÃ®chir statut</button>
            <button class="btn ok" id="btnBack" disabled>âœ… Retour au planning</button>
          </div>

          <div style="height:10px;"></div>

          <button class="btn bad" id="btnHelp">ğŸ’¬ Support WhatsApp</button>

          <div class="small" id="hint" style="margin-top:10px;"></div>

          <div class="hr"></div>

          <div class="small">
            ğŸ”¥ <b>Nouveau :</b> Paiement automatique avec QR Wave ! Le statut se met Ã  jour en temps rÃ©el.
          </div>
        </div>

        <div class="box">
          <h2>Choisis ton module PRO ğŸ¦…</h2>
          <p class="small">Abonnement Â· 0% commission Â· Tu gardes 100% de ce que tu gagnes</p>
          <p class="small">âœ“ Paiement direct Wave âœ“ Activation rapide âœ“ Made in SÃ©nÃ©gal</p>

          <div class="hr"></div>

          <!-- (Tes plans : inchangÃ©s) -->
          <!-- ... garde tes blocs plans tels quels ... -->

          <div class="hr"></div>
          <div class="small">Â© DIGIYLYFE â€” Made in SÃ©nÃ©gal ğŸ‡¸ğŸ‡³ Â· 0% commission Â· Paiement direct Â· SouverainetÃ© digitale</div>
        </div>
      </div>
    </div>
  </div>

  <div class="qr-modal" id="qrModal">
    <div class="qr-container">
      <h2>ğŸ“± Scanner pour payer</h2>
      <img id="qrImage" src="" alt="QR Code" class="qr-image" />
      <div class="qr-amount" id="qrAmount">â€”</div>
      <div class="qr-details">
        <div id="qrModule">Module: â€”</div>
        <div id="qrPlan">Plan: â€”</div>
      </div>

      <div class="qr-instructions">
        ğŸ“± Ouvre ton app <b>Wave</b><br/>
        ğŸ‘‰ Scanne ce QR code<br/>
        âœ… Confirme le paiement
      </div>

      <div class="qr-status">
        <div class="qr-status-text">â³ En attente du paiement...</div>
        <div class="qr-status-sub">Le statut se met Ã  jour automatiquement</div>
      </div>

      <button class="qr-btn-close" onclick="closeQRModal()">âŒ Annuler</button>
    </div>
  </div>

  <script>
(function(){
"use strict";

/* =========================
SUPABASE
========================= */
const SUPABASE_URL="https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const SUPPORT_WA="+221771342889";
const RECIPIENT_WAVE="+221771342889";

const $=id=>document.getElementById(id);
let pollingInterval=null;

/* =========================
HELPERS
========================= */
function qs(name){try{return new URL(location.href).searchParams.get(name)||"";}catch(e){return"";}}
function fmt(n){return Number(n||0).toLocaleString("fr-FR");}
function normPhone(p){
p=String(p||"").replace(/\s+/g,"");
if(p.startsWith("221"))p="+"+p;
return p;
}

/* =========================
STATE
========================= */
const slug=qs("slug");
const phone=normPhone(qs("phone"));
const accessModule=qs("module").toUpperCase();
let chosenModule=qs("m");
let chosenPlan=qs("plan");
let chosenAmount=qs("amount");

/* =========================
PAY BUTTON
========================= */
$("btnPayNow").onclick=async function(){

if(!phone||!chosenModule||!chosenAmount){
alert("Choisis un module et vÃ©rifie ton numÃ©ro frÃ©rot");
return;
}

const prenom=localStorage.getItem("digiy_prenom")||"DIGIY";
const nom=localStorage.getItem("digiy_nom")||"CLIENT";

const payload={
p_phone:phone,
p_module:chosenModule||"UNKNOWN",
p_plan:chosenPlan||"DEFAULT",
p_montant:Number(chosenAmount||0),
p_nom:nom,
p_prenom:prenom,
p_email:localStorage.getItem("digiy_email")||null,
p_access_module:accessModule||"LOC",
p_slug:slug||"no-slug",
p_metadata:{source:"pay-page"}
};

try{
$("btnPayNow").disabled=true;
$("statusText").textContent="ğŸ¦ Enregistrement caisse...";

const enc=await sb.rpc("digiy_caisse_enregistrer",payload);
if(enc.error)throw enc.error;

const encaissementId=enc.data.id;

$("statusText").textContent="ğŸ’³ CrÃ©ation paiement Wave...";

const pay=await sb.rpc("digiy_pay_create_request",{
p_module:"subscription",
p_module_ref_id:encaissementId,
p_amount_fcfa:payload.p_montant,
p_payer_phone:phone,
p_recipient_phone:RECIPIENT_WAVE,
p_provider:"wave",
p_description:"DIGIY "+chosenModule+" "+prenom+" "+nom,
p_metadata:JSON.stringify({encaissement_id:encaissementId,slug})
});
if(pay.error)throw pay.error;

const paymentId=pay.data.id;
const qr=pay.data.qr_code||pay.data.payment_link;

$("qrImage").src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data="+encodeURIComponent(qr);
$("qrModal").style.display="flex";

pollWave(paymentId);

}catch(e){
console.error(e);
alert("Erreur caisse ou paiement frÃ©rot");
$("btnPayNow").disabled=false;
}
};

/* =========================
POLL WAVE
========================= */
async function pollWave(paymentId){
pollingInterval=setInterval(async()=>{
const res=await sb.rpc("digiy_pay_check_status",{p_payment_id:paymentId});
if(res.data?.status==="completed"){
clearInterval(pollingInterval);
await sb.rpc("digiy_set_module_active",{p_phone:phone,p_module:accessModule});
$("statusText").textContent="âœ… Paiement confirmÃ© & module activÃ©";
$("qrModal").style.display="none";
}
},3000);
}

})();
</script>
</body>
</html>

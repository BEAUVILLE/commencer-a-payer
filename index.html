<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>COMMENCER √Ä PAYER ‚Äî DIGIYLYFE</title>
  <meta name="theme-color" content="#16a34a"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --gold:#facc15;
      --radius:18px; --shadow:0 18px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:720px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); }
    h1{ margin:0; font-size:20px; font-weight:1100; }
    p{ margin:8px 0 0; color:var(--muted); line-height:1.4; }
    .hr{ height:1px; background:var(--line); margin:14px 0; }

    .status{
      padding:12px; border-radius:16px; border:1px solid var(--line);
      font-weight:1000; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .status.ok{ border-color: rgba(34,197,94,.55); }
    .status.warn{ border-color: rgba(245,158,11,.55); }
    .status.bad{ border-color: rgba(239,68,68,.55); }

    .tag{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .tag.ok{ color: var(--ok); border-color: rgba(34,197,94,.45); }
    .tag.warn{ color: var(--warn); border-color: rgba(245,158,11,.45); }
    .tag.bad{ color: var(--bad); border-color: rgba(239,68,68,.45); }

    .btn{
      width:100%; min-height:52px; border-radius:16px; cursor:pointer;
      border:1px solid var(--line); background:transparent; color:var(--text);
      padding:12px 14px; font-weight:1100;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.ok{ border-color: rgba(34,197,94,.55); }
    .btn.warn{ border-color: rgba(245,158,11,.55); }
    .btn.bad{ border-color: rgba(239,68,68,.55); }
    .btn.gold{ border-color: rgba(250,204,21,.65); }

    .box{ border:1px solid var(--line); border-radius:16px; padding:14px; background:rgba(0,0,0,.12); }
    .steps{ margin:0; padding-left:18px; color:var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:220px; }
    .small{ font-size:13px; color:var(--muted); line-height:1.35; }
    .hide{ display:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>COMMENCER √Ä PAYER ‚Äî DIGIYLYFE</h1>
      <p class="small">0% commission ¬∑ Paiement Wave ¬∑ Activation DIGIY</p>

      <div class="hr"></div>

      <div class="status warn" id="statusBox">
        <div id="statusText">‚è≥ Pr√©paration‚Ä¶</div>
        <span class="tag warn" id="statusTag">EN COURS</span>
      </div>

      <div class="hr"></div>

      <!-- TOKEN MODE -->
      <div class="box" id="tokenBox">
        <h2 style="margin:0;font-size:16px;font-weight:1100;">üîê Activation s√©curis√©e</h2>
        <p class="small">Si tu as re√ßu un lien DIGIY avec token, clique simplement.</p>

        <div class="hr"></div>

        <button class="btn ok" id="btnActivateToken">
          ‚úÖ Activer maintenant
          <span id="spinnerToken" class="mono" style="display:none;margin-left:8px;">‚è≥</span>
        </button>

        <p class="small" id="tokenHint" style="margin-top:10px;"></p>
      </div>

      <div class="hr"></div>

      <!-- MANUAL MODE -->
      <div class="box" id="manualBox">
        <h2 style="margin:0;font-size:16px;font-weight:1100;">üí≥ Paiement manuel (Wave)</h2>
        <p class="small">Paye sur Wave, puis envoie le re√ßu sur WhatsApp. On active ensuite.</p>

        <div class="hr"></div>

        <div class="row">
          <div>
            <div style="font-weight:1100;">B√©n√©ficiaire</div>
            <div class="mono" style="font-weight:1000;">JB BEAUVILLE</div>
          </div>
          <div>
            <div style="font-weight:1100;">Num√©ro Wave</div>
            <div class="mono" style="font-weight:1000;" id="waveTo">+221 77 134 28 89</div>
          </div>
        </div>

        <div class="hr"></div>

        <ol class="steps">
          <li>Fais le transfert Wave</li>
          <li>Envoie le re√ßu sur WhatsApp</li>
          <li>Retourne au module (activation apr√®s validation)</li>
        </ol>

        <div class="hr"></div>

        <div class="row">
          <button class="btn gold" id="btnWaConfirm">üí¨ Confirmer WhatsApp (avec re√ßu)</button>
          <button class="btn bad" id="btnSupport">üõü Support WhatsApp</button>
        </div>

        <p class="small" id="manualHint" style="margin-top:10px;"></p>
      </div>

      <!-- Debug cach√© (si tu veux garder) -->
      <div class="hide" id="dbg"></div>
    </div>
  </div>

  <script>
  (function(){
    "use strict";

    // === CONFIG SUPABASE (TES VALEURS) ===
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // WhatsApp
    const SUPPORT_WA = "+221771342889";
    const WAVE_TO = "+221771342889"; // affichage + message (mets 771342889 ou num√©ro que tu veux)

    const $ = (id)=>document.getElementById(id);
    const qp = new URLSearchParams(location.search);

    function setStatus(text, tone, tag){
      const box = $("statusBox");
      box.className = "status " + (tone || "warn");
      $("statusText").textContent = text || "";
      const t = $("statusTag");
      t.className = "tag " + (tone || "warn");
      t.textContent = tag || "‚Äî";
    }

    function wa(msg){
      const num = SUPPORT_WA.replace(/\+/g,"");
      location.href = "https://wa.me/" + num + "?text=" + encodeURIComponent(msg);
    }

    function normPhone(p){
      p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
      if(p.startsWith("00221")) p = "+221" + p.slice(5);
      if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
      if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
      return p;
    }

    // === INPUTS URL (optionnels) ===
    const token = (qp.get("token") || "").trim();
    const ret = (qp.get("return") || "").trim();
    const auto = (qp.get("auto") === "1");

    const phone = normPhone(qp.get("phone") || "");      // utile pour WhatsApp message
    const kind = (qp.get("kind") || "").trim().toLowerCase(); // module|addon
    const m = (qp.get("m") || "").trim();                // ex: EXPLORE
    const plan = (qp.get("plan") || "").trim();          // ex: boost_city
    const amount = (qp.get("amount") || "").toString().replace(/[^\d]/g,""); // ex: 14900
    const slug = (qp.get("slug") || "").trim();
    const access = (qp.get("module") || "").trim().toUpperCase(); // ex: LOC
    const from = (qp.get("from") || "").trim();

    // UI
    $("waveTo").textContent = "+221 77 134 28 89"; // affichage friendly (change si besoin)

    // --- TOKEN MODE visibility ---
    if(!token){
      $("tokenBox").classList.add("hide");
      setStatus("üí≥ Paiement Wave : confirme sur WhatsApp avec le re√ßu.", "warn", "MANUEL");
      $("manualHint").textContent = "Astuce : apr√®s envoi du re√ßu, l‚Äôactivation se fait rapidement.";
    } else {
      setStatus("üîê Lien s√©curis√© d√©tect√©. Clique pour activer.", "ok", "TOKEN");
      $("tokenHint").textContent = "Token d√©tect√©. Activation en 1 clic.";
    }

    // --- Activate token ---
    async function activateToken(){
      if(!token){
        alert("Token manquant.");
        return;
      }
      $("btnActivateToken").disabled = true;
      $("spinnerToken").style.display = "inline-block";
      setStatus("‚è≥ Activation s√©curis√©e en cours‚Ä¶", "warn", "EN COURS");

      try{
        const { data, error } = await sb.rpc("digiy_pay_activate_token", { p_token: token });
        if(error) throw error;
        if(!data?.ok) throw new Error(data?.reason || "activation_failed");

        setStatus("üü¢ Activ√© ! Tu peux continuer.", "ok", "ACTIF");

        // redirect
        if(ret){
          const u = new URL(ret, location.origin);
          u.searchParams.set("from", "digiy-pay-token");
          location.href = u.toString();
        } else {
          $("tokenHint").textContent = "Activation OK. Tu peux fermer cette page.";
        }
      } catch(e){
        console.error(e);
        setStatus("üî¥ Activation impossible. Contacte le support.", "bad", "ERREUR");
        $("tokenHint").textContent = String(e.message || e);
      } finally {
        $("spinnerToken").style.display = "none";
        $("btnActivateToken").disabled = false;
      }
    }

    $("btnActivateToken").addEventListener("click", activateToken);

    if(auto && token){
      setTimeout(activateToken, 400);
    }

    // --- WhatsApp confirm (manual) ---
    $("btnWaConfirm").addEventListener("click", function(){
      let msg = "DIGIY ‚Äî Confirmation paiement Wave\n\n";
      msg += "B√©n√©ficiaire: JB BEAUVILLE\n";
      msg += "Wave: " + WAVE_TO + "\n\n";
      if(phone) msg += "T√©l√©phone: " + phone + "\n";
      if(access) msg += "Acc√®s: " + access + "\n";
      if(kind) msg += "Type: " + kind + "\n";
      if(m) msg += "Produit: " + m + "\n";
      if(plan) msg += "Plan: " + plan + "\n";
      if(amount) msg += "Montant: " + amount + " FCFA\n";
      if(slug) msg += "Slug: " + slug + "\n";
      if(token) msg += "Token: " + token + "\n";
      msg += "\nJe joins le re√ßu Wave ici.\nMerci d'activer. ‚Äî DIGIY";

      wa(msg);
      setStatus("‚úÖ Message WhatsApp pr√™t. Ajoute le re√ßu.", "warn", "EN ATTENTE");
    });

    $("btnSupport").addEventListener("click", function(){
      let msg = "DIGIY ‚Äî Support Paiement\n\n";
      if(phone) msg += "T√©l√©phone: " + phone + "\n";
      if(m) msg += "Produit: " + m + "\n";
      if(plan) msg += "Plan: " + plan + "\n";
      if(amount) msg += "Montant: " + amount + " FCFA\n";
      if(slug) msg += "Slug: " + slug + "\n";
      msg += "\nJ'ai besoin d'aide. ‚Äî DIGIY";
      wa(msg);
      setStatus("üí¨ Support WhatsApp‚Ä¶", "warn", "INFO");
    });

    // Optional back
    // si tu veux un bouton retour plus tard, on le remet (mais je l‚Äôai retir√© pour friction 0)
    if(from){
      $("manualHint").textContent = "Apr√®s activation, retourne sur ton module.";
    }
  })();
  </script>
</body>
</html>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY PRO ‚Ä¢ Paiement & Activation</title>
  <meta name="theme-color" content="#16a34a"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px; --shadow:0 18px 50px rgba(0,0,0,.35);
      --gold:#facc15;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    h1{ margin:0; font-size:20px; font-weight:1100; letter-spacing:.2px; }
    h2{ margin:0; font-size:16px; font-weight:1100; }
    p{ margin:8px 0 0; color:var(--muted); line-height:1.35; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid var(--line); border-radius:999px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .small{ font-size:13px; color:var(--muted); line-height:1.35; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    @media(min-width:980px){ .grid{ grid-template-columns:1.03fr .97fr; } }

    .statusBig{
      margin-top:12px; padding:12px; border-radius:16px;
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-weight:1100;
    }
    .statusBig.ok{ border-color: rgba(34,197,94,.55); }
    .statusBig.warn{ border-color: rgba(245,158,11,.55); }
    .statusBig.bad{ border-color: rgba(239,68,68,.55); }

    .tag{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .tag.ok{ color: var(--ok); border-color: rgba(34,197,94,.45); }
    .tag.warn{ color: var(--warn); border-color: rgba(245,158,11,.45); }
    .tag.bad{ color: var(--bad); border-color: rgba(239,68,68,.45); }

    .btn{
      border:1px solid var(--line); background:transparent; color:var(--text);
      padding:12px 14px; border-radius:16px; cursor:pointer; font-weight:1100;
      min-height:52px; width:100%;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.ok{ border-color: rgba(34,197,94,.55); }
    .btn.warn{ border-color: rgba(245,158,11,.55); }
    .btn.bad{ border-color: rgba(239,68,68,.55); }
    .btn.gold{ border-color: rgba(250,204,21,.65); }

    .box{ border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(0,0,0,.12); }
    .cards{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:740px){ .cards{ grid-template-columns:repeat(2,1fr); } }

    .plan{
      border:1px solid var(--line); border-radius:16px; padding:12px;
      background:rgba(0,0,0,.10);
      display:flex; flex-direction:column; gap:10px;
    }
    .planHead{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted);
      white-space:nowrap;
    }
    .badge.pop{ border-color:rgba(250,204,21,.55); color:var(--gold); }
    .price{ font-size:18px; font-weight:1200; }
    .list{ margin:0; padding-left:18px; color:var(--muted); font-size:13px; line-height:1.35; }
    .list li{ margin:4px 0; }
    .actions2{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:560px){ .actions2{ grid-template-columns:1fr 1fr; } }

    .selectLine{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .k{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
        font-size:12px; padding:2px 6px; border:1px solid var(--line); border-radius:8px; color:var(--muted);
        background:rgba(0,0,0,.12);
    }

    .qr-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .qr-container {
      background: #fff;
      border-radius: 24px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .qr-container h2 { color: #000; margin: 0 0 20px; font-size: 24px; }
    .qr-image {
      width: 300px; height: 300px; margin: 20px auto;
      border: 3px solid #22c55e; border-radius: 16px; padding: 10px; background: #fff;
    }
    .qr-amount { font-size: 36px; font-weight: 900; color: #facc15; margin: 20px 0; }
    .qr-details { color: #666; font-size: 14px; margin: 10px 0; font-weight: 900; }
    .qr-status { background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 15px; margin: 20px 0; }
    .qr-status-text { color: #16a34a; font-weight: 900; font-size: 16px; }
    .qr-status-sub { color: #666; font-size: 12px; margin-top: 5px; }
    .qr-btn-close {
      width: 100%; padding: 15px; background: #ef4444; color: #fff;
      border: none; border-radius: 12px; font-weight: 900; cursor: pointer; font-size: 16px; margin-top: 10px;
    }
    .qr-btn-close:hover { background: #dc2626; }
    .qr-instructions {
      background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px;
      padding: 15px; margin: 15px 0; color: #92400e; font-weight: 900; font-size: 13px;
    }

    input[type="text"], input[type="email"] {
      padding: 14px; border: 1px solid var(--line); border-radius: 12px;
      background: rgba(0,0,0,.12); color: var(--text); font-size: 15px; font-weight: 500; width: 100%;
    }
    input[type="text"]:focus, input[type="email"]:focus { outline: none; border-color: var(--ok); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1>DIGIY PRO</h1>
          <p class="small"><b>0% Commission</b> ¬∑ Paiement Direct</p>
        </div>
        <div class="row">
          <span class="pill">üì¶ acc√®s: <span class="mono" id="pillAccess">‚Äî</span></span>
          <span class="pill">üì¶ choisi: <span class="mono" id="pillModule">‚Äî</span></span>
          <span class="pill">üì± phone: <span class="mono" id="pillPhone">‚Äî</span></span>
          <span class="pill">üè∑Ô∏è slug: <span class="mono" id="pillSlug">‚Äî</span></span>
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <h2>‚ÑπÔ∏è Paiement & Activation DIGIY</h2>
        <p class="small">
          Effectue d'abord le paiement via <b>Wave</b>, puis confirme sur <b>WhatsApp</b>.
          (Cette page sait revenir automatiquement au planning)
        </p>
      </div>

      <div class="statusBig warn" id="statusBig">
        <div id="statusText">‚è≥ V√©rification du statut‚Ä¶</div>
        <span class="tag warn" id="tag">EN COURS</span>
      </div>

      <!-- üë§ SECTION INFOS CLIENT -->
      <div class="card" id="clientInfoBox" style="margin-top:16px; display:none;">
        <h2>üë§ Tes informations</h2>
        <p class="small">Pour bien enregistrer ton abonnement dans la caisse DIGIYLYFE</p>

        <div class="hr"></div>

        <div style="display:grid; gap:12px;">
          <input type="text" id="inputPrenom" placeholder="Pr√©nom *">
          <input type="text" id="inputNom" placeholder="Nom *">
          <input type="email" id="inputEmail" placeholder="Email (optionnel)">
        </div>

        <div class="hr"></div>

        <button class="btn ok" id="btnSaveInfo">‚úÖ Valider mes infos</button>

        <p class="small" style="margin-top:8px; color:var(--muted);">
          * Champs obligatoires ¬∑ Ces infos sont enregistr√©es pour ton abonnement
        </p>
      </div>

      <div class="grid">
        <div class="box">
          <h2>üí≥ Paiement via Wave</h2>
          <p class="small">Scanne le QR avec ton app Wave :</p>

          <div class="hr"></div>

          <div class="selectLine">
            <div>
              <div style="font-weight:1200;">üì± JB BEAUVILLE</div>
              <div class="mono" style="font-weight:1100;">+221 77 134 28 89</div>
              <div class="small">Montant = prix du module choisi</div>
            </div>
            <div class="pill">Montant: <span class="mono" id="pillAmount">‚Äî</span></div>
          </div>

          <div class="hr"></div>

          <h2>üí¨ Confirmation WhatsApp</h2>
          <p class="small">Apr√®s le paiement, envoie : ‚úÖ le re√ßu Wave ‚úÖ le module/pack choisi</p>

          <div class="hr"></div>

          <div style="font-weight:1200;">üìå R√©sum√© automatique</div>
          <div class="small">
            üì¶ acc√®s: <span class="mono" id="sumAccess">‚Äî</span><br/>
            üì¶ module: <span class="mono" id="sumModule">‚Äî</span><br/>
            üì± phone: <span class="mono" id="sumPhone">‚Äî</span><br/>
            üè∑Ô∏è slug: <span class="mono" id="sumSlug">‚Äî</span><br/>
            üßæ plan: <span class="mono" id="sumPlan">‚Äî</span><br/>
            üí∞ montant: <span class="mono" id="sumAmount">‚Äî</span>
          </div>

          <div class="hr"></div>

          <div class="actions2">
            <button class="btn gold" id="btnPayNow">‚ö° Payer maintenant (Wave QR)</button>
            <button class="btn warn" id="btnWaConfirm">üí¨ Confirmer sur WhatsApp</button>
          </div>

          <div style="height:10px;"></div>

          <div class="actions2">
            <button class="btn warn" id="btnRefresh">üîÑ Rafra√Æchir statut</button>
            <button class="btn ok" id="btnBack" disabled>‚úÖ Retour au planning</button>
          </div>

          <div style="height:10px;"></div>

          <button class="btn bad" id="btnHelp">üí¨ Support WhatsApp</button>

          <div class="small" id="hint" style="margin-top:10px;"></div>

          <div class="hr"></div>

          <div class="small">
            üî• <b>Nouveau :</b> Paiement automatique avec QR Wave ! Le statut se met √† jour en temps r√©el.
          </div>
        </div>

        <div class="box">
          <h2>Choisis ton module PRO ü¶Ö</h2>
          <p class="small">Abonnement ¬∑ 0% commission ¬∑ Tu gardes 100% de ce que tu gagnes</p>
          <p class="small">‚úì Paiement direct Wave ‚úì Activation rapide ‚úì Made in S√©n√©gal</p>

          <div class="hr"></div>

          <!-- (Tes plans : inchang√©s) -->
          <!-- ... garde tes blocs plans tels quels ... -->

          <div class="hr"></div>
          <div class="small">¬© DIGIYLYFE ‚Äî Made in S√©n√©gal üá∏üá≥ ¬∑ 0% commission ¬∑ Paiement direct ¬∑ Souverainet√© digitale</div>
        </div>
      </div>
    </div>
  </div>

  <div class="qr-modal" id="qrModal">
    <div class="qr-container">
      <h2>üì± Scanner pour payer</h2>
      <img id="qrImage" src="" alt="QR Code" class="qr-image" />
      <div class="qr-amount" id="qrAmount">‚Äî</div>
      <div class="qr-details">
        <div id="qrModule">Module: ‚Äî</div>
        <div id="qrPlan">Plan: ‚Äî</div>
      </div>

      <div class="qr-instructions">
        üì± Ouvre ton app <b>Wave</b><br/>
        üëâ Scanne ce QR code<br/>
        ‚úÖ Confirme le paiement
      </div>

      <div class="qr-status">
        <div class="qr-status-text">‚è≥ En attente du paiement...</div>
        <div class="qr-status-sub">Le statut se met √† jour automatiquement</div>
      </div>

      <button class="qr-btn-close" onclick="closeQRModal()">‚ùå Annuler</button>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      // =========================
      // SUPABASE
      // =========================
      const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const SUPPORT_WA = "+221771342889";
      const RECIPIENT_WAVE = "+221771342889";

      const $ = (id)=>document.getElementById(id);
      let pollingInterval = null;

      // =========================
      // HELPERS
      // =========================
      function qs(name){
        try{ return new URL(location.href).searchParams.get(name) || ""; }catch(e){ return ""; }
      }
      function setQS(name, value){
        const u = new URL(location.href);
        if(value === null || value === undefined || value === "") u.searchParams.delete(name);
        else u.searchParams.set(name, value);
        history.replaceState({}, "", u.toString());
      }
      function fmt(n){
        n = Number(n||0);
        if(!isFinite(n) || n<=0) return "‚Äî";
        return n.toLocaleString("fr-FR");
      }
      function normPhone(p){
        p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
        if(p.startsWith("00221")) p = "+221" + p.slice(5);
        if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
        if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
        return p;
      }
      function wa(msg){
        location.href = "https://wa.me/" + SUPPORT_WA.replace(/\+/g,"") + "?text=" + encodeURIComponent(msg);
      }

      // =========================
      // STATE (URL)
      // =========================
      const from = (qs("from") || "").trim();
      const slug = (qs("slug") || "").trim();
      const phone = normPhone(qs("phone") || "");
      const accessModule = String(qs("module") || "").trim().toUpperCase();

      let status = (qs("status") || "").trim().toLowerCase();
      let chosenModule = (qs("m") || "").trim().toUpperCase();
      let chosenPlan = (qs("plan") || "").trim();
      let chosenAmount = (qs("amount") || "").trim();

      // =========================
      // UI INIT
      // =========================
      $("pillAccess").textContent = accessModule || "‚Äî";
      $("pillModule").textContent = chosenModule || "‚Äî";
      $("pillPhone").textContent = phone || "‚Äî";
      $("pillSlug").textContent = slug || "‚Äî";

      function syncSummary(){
        $("sumAccess").textContent = accessModule || "‚Äî";
        $("sumModule").textContent = chosenModule || "‚Äî";
        $("sumPhone").textContent = phone || "‚Äî";
        $("sumSlug").textContent = slug || "‚Äî";
        $("sumPlan").textContent = chosenPlan || "‚Äî";
        $("sumAmount").textContent = chosenAmount ? (fmt(chosenAmount) + " F") : "‚Äî";
        $("pillAmount").textContent = chosenAmount ? (fmt(chosenAmount) + " F") : "‚Äî";
        $("pillModule").textContent = chosenModule || "‚Äî";
      }
      function setHint(msg){ $("hint").textContent = msg || ""; }
      function setBig(text, tone, tagText){
        const el = $("statusBig");
        el.className = "statusBig " + (tone || "warn");
        $("statusText").textContent = text;
        const tag = $("tag");
        tag.className = "tag " + (tone || "warn");
        tag.textContent = tagText || "‚Äî";
      }
      syncSummary();

      function safeBack(){
        if(from){ location.replace(from); return; }
        location.replace("https://beauville.github.io/digiy-loc-pro/login.html" + (slug ? "?slug="+encodeURIComponent(slug) : ""));
      }

      function ensureChoice(){
        if(!phone){ setHint("T√©l√©phone manquant (param√®tre ?phone=...)."); return false; }
        if(!accessModule){ setHint("Acc√®s module manquant (?module=LOC / DRIVER / ...)."); return false; }
        if(!chosenModule){ setHint("Choisis un module."); return false; }
        if(!chosenAmount){ setHint("Choisis un tarif."); return false; }
        return true;
      }

      function pick(mod, plan, amount){
        chosenModule = String(mod||"").trim().toUpperCase();
        chosenPlan = String(plan||"").trim();
        chosenAmount = String(amount||"").trim();
        setQS("m", chosenModule);
        setQS("plan", chosenPlan);
        setQS("amount", chosenAmount);
        syncSummary();
        setHint("Choix enregistr√©.");
      }

      // branche les boutons de choix
      document.querySelectorAll("[data-choose]").forEach((btn)=>{
        btn.addEventListener("click", ()=>{
          pick(btn.getAttribute("data-choose"), btn.getAttribute("data-plan"), btn.getAttribute("data-amount"));
        });
      });

      // =========================
      // QR MODAL
      // =========================
      function showPaymentQR(params){
        const modal = $("qrModal");
        const qrImage = $("qrImage");

        const qrCode = params.qrCode || "";
        if(qrCode.startsWith("data:image") || qrCode.startsWith("http")){
          qrImage.src = qrCode;
        }else{
          qrImage.src = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(qrCode);
        }

        $("qrAmount").textContent = fmt(params.amount) + " F CFA";
        $("qrModule").textContent = "Module: " + params.module;
        $("qrPlan").textContent = "Plan: " + params.plan;

        modal.style.display = "flex";
        startPaymentPolling(params.paymentId);
      }

      window.closeQRModal = function(){
        $("qrModal").style.display = "none";
        if(pollingInterval) clearInterval(pollingInterval);
        pollingInterval = null;
        $("btnPayNow").disabled = false;
      };

      async function startPaymentPolling(paymentId){
        if(pollingInterval) clearInterval(pollingInterval);

        pollingInterval = setInterval(async ()=>{
          try{
            const res = await sb.rpc("digiy_pay_check_status", { p_payment_id: paymentId });
            if(res.error) throw res.error;

            const data = res.data || {};
            if(data.status === "completed"){
              clearInterval(pollingInterval);
              pollingInterval = null;
              closeQRModal();
              setBig("Paiement confirm√©!", "ok", "PAY√â");
              setHint("Activation en cours...");
              setTimeout(()=>checkStatus(true), 2000);
            }
            if(data.status === "failed"){
              clearInterval(pollingInterval);
              pollingInterval = null;
              closeQRModal();
              setBig("Paiement √©chou√©", "bad", "√âCHEC");
              setHint("R√©essaie ou contacte le support.");
            }
          }catch(e){
            console.error("Polling error:", e);
          }
        }, 3000);

        // timeout 10 min
        setTimeout(()=>{
          if(!pollingInterval) return;
          clearInterval(pollingInterval);
          pollingInterval = null;
          closeQRModal();
          setBig("Temps √©coul√©", "warn", "TIMEOUT");
          setHint("Paiement non d√©tect√©. V√©rifie ton compte Wave.");
        }, 600000);
      }

      // =========================
      // CLIENT INFO
      // =========================
      const savedPrenom = localStorage.getItem("digiy_prenom") || "";
      const savedNom = localStorage.getItem("digiy_nom") || "";
      const savedEmail = localStorage.getItem("digiy_email") || "";
      if(savedPrenom) $("inputPrenom").value = savedPrenom;
      if(savedNom) $("inputNom").value = savedNom;
      if(savedEmail) $("inputEmail").value = savedEmail;

      $("btnSaveInfo").onclick = function(){
        const prenom = $("inputPrenom").value.trim();
        const nom = $("inputNom").value.trim();
        const email = $("inputEmail").value.trim();

        if(!prenom || !nom){
          alert("‚ö†Ô∏è Pr√©nom et Nom sont obligatoires fr√©rot!");
          return;
        }
        localStorage.setItem("digiy_prenom", prenom);
        localStorage.setItem("digiy_nom", nom);
        if(email) localStorage.setItem("digiy_email", email);

        $("clientInfoBox").style.display = "none";
        setHint("‚úÖ Infos enregistr√©es! Clique sur 'Payer maintenant' üëá");
        $("btnPayNow").scrollIntoView({ behavior:"smooth", block:"center" });
      };

      // =========================
      // ACTIONS
      // =========================
      $("btnPayNow").onclick = async function(){
        if(!ensureChoice()) return;

        const prenom = localStorage.getItem("digiy_prenom") || "";
        const nom = localStorage.getItem("digiy_nom") || "";
        if(!prenom || !nom){
          $("clientInfoBox").style.display = "block";
          $("clientInfoBox").scrollIntoView({ behavior:"smooth", block:"center" });
          setHint("üëÜ Remplis tes infos d'abord fr√©rot!");
          return;
        }

        try{
          setBig("üîÑ Enregistrement caisse centrale...", "warn", "EN COURS");
          $("btnPayNow").disabled = true;

          // 1) encaissement
          const encaissement = await sb.rpc("digiy_caisse_enregistrer", {
            p_phone: phone,
            p_module: chosenModule,
            p_plan: chosenPlan,
            p_montant: parseInt(chosenAmount,10),
            p_nom: nom,
            p_prenom: prenom,
            p_email: localStorage.getItem("digiy_email") || null,
            p_access_module: accessModule,
            p_slug: slug,
            p_metadata: {
              user_agent: navigator.userAgent,
              timestamp: new Date().toISOString(),
              page_url: location.href
            }
          });
          if(encaissement.error) throw encaissement.error;

          const encaissementId = encaissement.data?.id;
          if(!encaissementId) throw new Error("encaissement_id_missing");

          // 2) paiement wave
          setBig("üí≥ Cr√©ation du paiement Wave...", "warn", "EN COURS");

          const metaObj = {
            encaissement_id: encaissementId,
            access_module: accessModule,
            chosen_module: chosenModule,
            chosen_plan: chosenPlan,
            slug: slug,
            phone: phone,
            nom: nom,
            prenom: prenom
          };

          const pay = await sb.rpc("digiy_pay_create_request", {
            p_module: "subscription",
            p_module_ref_id: encaissementId,
            p_amount_fcfa: parseInt(chosenAmount,10),
            p_payer_phone: phone,
            p_recipient_phone: RECIPIENT_WAVE,
            p_provider: "wave",
            p_description: "DIGIY PRO - " + chosenModule + " - " + chosenPlan + " - " + prenom + " " + nom,
            p_metadata: JSON.stringify(metaObj)
          });
          if(pay.error) throw pay.error;

          const data = pay.data || {};
          if(!data.ok) throw new Error(data.reason || "payment_creation_failed");

          const paymentId = data.id;

          setBig("‚úÖ QR g√©n√©r√©!", "ok", "PR√äT");
          showPaymentQR({
            paymentId,
            encaissementId,
            qrCode: data.qr_code || data.payment_link,
            amount: chosenAmount,
            module: chosenModule,
            plan: chosenPlan
          });

        }catch(e){
          console.error("‚ùå Erreur:", e);
          setBig("‚ùå Erreur", "bad", "ERREUR");
          setHint("Erreur: " + (e.message || e));
          $("btnPayNow").disabled = false;
        }
      };

      $("btnWaConfirm").onclick = function(){
        if(!ensureChoice()) return;

        let msg = "DIGIY PRO - Confirmation paiement Wave\n\n";
        msg += "B√©n√©ficiaire: JB BEAUVILLE\n";
        msg += "Wave: " + SUPPORT_WA + "\n\n";
        msg += "Acc√®s: " + (accessModule || "LOC") + "\n";
        msg += "Produit: " + chosenModule + "\n";
        msg += "Plan: " + (chosenPlan || "‚Äî") + "\n";
        msg += "Montant: " + fmt(chosenAmount) + " F CFA\n";
        msg += "T√©l√©phone: " + (phone || "‚Äî") + "\n";
        msg += "Slug: " + (slug || "‚Äî") + "\n\n";
        msg += "Je viens de payer via Wave.\n";
        msg += "Je joins le re√ßu Wave ici.\n\n";
        msg += "Merci d'activer mon acc√®s. ‚Äî DIGIY";

        wa(msg);

        status = "pending";
        setQS("status", "pending");
        setBig("Confirmation envoy√©e.", "warn", "EN ATTENTE");
        setHint("Envoie le re√ßu Wave.");
      };

      $("btnHelp").onclick = function(){
        let msg = "DIGIY PRO - Support\n\n";
        msg += "Acc√®s: " + (accessModule || "LOC") + "\n";
        msg += "Produit: " + (chosenModule || "‚Äî") + "\n";
        msg += "Plan: " + (chosenPlan || "‚Äî") + "\n";
        msg += "Montant: " + (chosenAmount ? (fmt(chosenAmount)+" F") : "‚Äî") + "\n";
        msg += "T√©l√©phone: " + (phone || "‚Äî") + "\n";
        msg += "Slug: " + (slug || "‚Äî") + "\n";
        msg += "Statut: " + (status || "‚Äî") + "\n\n";
        msg += "J'ai besoin d'aide. Merci. ‚Äî DIGIY";
        wa(msg);
      };

      $("btnBack").onclick = safeBack;
      $("btnRefresh").onclick = ()=>checkStatus(true);

      // =========================
      // STATUS CHECK
      // =========================
      async function checkStatus(){
        $("btnRefresh").disabled = true;
        setHint("");

        setBig("V√©rification...", "warn", "EN COURS");

        if(!phone){
          setBig("T√©l√©phone manquant.", "bad", "INACTIF");
          setHint("On attend ?phone=+221...");
          $("btnBack").disabled = true;
          $("btnRefresh").disabled = false;
          return;
        }

        const m = (accessModule || "LOC").toUpperCase();

        try{
          const res = await sb.rpc("is_module_active", { p_phone: phone, p_module: m });
          if(res.error) throw res.error;

          const active = !!res.data;
          if(active){
            setQS("status", "active");
            status = "active";
            setBig("Abonnement ACTIF.", "ok", "ACTIF");
            setHint("Tu peux revenir au planning.");
            $("btnBack").disabled = false;
          }else{
            if(status === "pending"){
              setBig("Paiement EN ATTENTE.", "warn", "EN ATTENTE");
              setHint("Activation apr√®s validation.");
              $("btnBack").disabled = true;
            }else{
              setBig("Abonnement INACTIF.", "bad", "INACTIF");
              setHint("Choisis un produit puis paie.");
              $("btnBack").disabled = true;
            }
          }
        }catch(e){
          console.error(e);
          setBig("Erreur v√©rification.", "bad", "ERREUR");
          setHint("Supabase: " + String(e.message || e));
          $("btnBack").disabled = true;
        }finally{
          $("btnRefresh").disabled = false;
        }
      }

      // init
      checkStatus();

    })();
  </script>
</body>
</html>

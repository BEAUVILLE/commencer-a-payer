<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>COMMENCER Ã€ PAYER â€” DIGIYLYFE</title>
  <meta name="theme-color" content="#16a34a"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --gold:#facc15;
      --radius:18px; --shadow:0 18px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:760px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); }
    h1{ margin:0; font-size:20px; font-weight:1100; }
    p{ margin:8px 0 0; color:var(--muted); line-height:1.4; }
    .hr{ height:1px; background:var(--line); margin:14px 0; }

    .status{
      padding:12px; border-radius:16px; border:1px solid var(--line);
      font-weight:1000; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .status.ok{ border-color: rgba(34,197,94,.55); }
    .status.warn{ border-color: rgba(245,158,11,.55); }
    .status.bad{ border-color: rgba(239,68,68,.55); }

    .tag{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .tag.ok{ color: var(--ok); border-color: rgba(34,197,94,.45); }
    .tag.warn{ color: var(--warn); border-color: rgba(245,158,11,.45); }
    .tag.bad{ color: var(--bad); border-color: rgba(239,68,68,.45); }

    .btn{
      width:100%; min-height:52px; border-radius:16px; cursor:pointer;
      border:1px solid var(--line); background:transparent; color:var(--text);
      padding:12px 14px; font-weight:1100;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.ok{ border-color: rgba(34,197,94,.55); }
    .btn.warn{ border-color: rgba(245,158,11,.55); }
    .btn.bad{ border-color: rgba(239,68,68,.55); }
    .btn.gold{ border-color: rgba(250,204,21,.65); }

    .box{ border:1px solid var(--line); border-radius:16px; padding:14px; background:rgba(0,0,0,.12); }
    .steps{ margin:0; padding-left:18px; color:var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:220px; }
    .small{ font-size:13px; color:var(--muted); line-height:1.35; }
    .hide{ display:none; }

    /* Lang switch */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap; margin-bottom:10px;
    }
    .lang-switch{
      display:flex; gap:6px; padding:4px; border-radius:999px;
      border:1px solid var(--line); background:rgba(0,0,0,.08);
    }
    .lang-switch button{
      border:none; padding:7px 12px; border-radius:999px; cursor:pointer;
      font-weight:1100; font-size:12px; background:transparent; color:var(--text);
    }
    .lang-switch button.active{ background:#0f172a; color:#fff; }

    /* Pricing grid â€” MENU CODIFIÃ‰ */
    .section-sep{
      margin:16px 0 8px;
      font-size:11px; font-weight:1100; letter-spacing:.8px;
      text-transform:uppercase; color:var(--gold);
      display:flex; align-items:center; gap:8px;
    }
    .section-sep::after{
      content:""; flex:1; height:1px; background:rgba(250,204,21,.18);
    }

    .priceGrid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(220px,1fr));
      gap:10px;
    }
    .priceBtn{
      text-align:left;
      border:1px solid var(--line);
      background:rgba(0,0,0,.10);
      border-radius:16px;
      padding:12px;
      cursor:pointer;
      color:var(--text);
      transition:border-color .18s;
    }
    .priceBtn:hover{ border-color: rgba(250,204,21,.55); }
    .priceBtn.active{
      border-color: rgba(250,204,21,.85);
      background:rgba(250,204,21,.06);
      box-shadow: 0 10px 30px rgba(250,204,21,.08);
    }
    .priceTop{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
    }
    .priceCode{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:34px; height:34px; border-radius:8px;
      background:linear-gradient(135deg,#667eea,#764ba2);
      font-size:13px; font-weight:1100; color:#fff; flex-shrink:0;
    }
    .priceCode.gold{ background:linear-gradient(135deg,#facc15,#f59e0b); color:#0f172a; }
    .priceName{ font-size:13px; font-weight:1100; line-height:1.2; }
    .priceAmt{ font-size:13px; font-weight:1100; color: var(--gold); white-space:nowrap; }
    .priceDesc{ margin-top:6px; font-size:11px; color:var(--muted); line-height:1.35; }
    .hintLine{ margin-top:10px; font-size:12px; color:var(--muted); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="topbar">
        <div class="lang-switch" aria-label="Language switch">
          <button id="lang-fr" class="active" type="button">FR</button>
          <button id="lang-wo" type="button">WO</button>
        </div>
        <span class="tag" data-i18n="tag_digiy">DIGIY PAY</span>
      </div>

      <h1 data-i18n="page_title">COMMENCER Ã€ PAYER â€” DIGIYLYFE</h1>
      <p class="small" data-i18n="subtitle">0% commission Â· Paiement Wave Â· Activation DIGIY</p>

      <div class="hr"></div>

      <div class="status warn" id="statusBox">
        <div id="statusText" data-i18n="status_preparing">â³ PrÃ©parationâ€¦</div>
        <span class="tag warn" id="statusTag" data-i18n="tag_in_progress">EN COURS</span>
      </div>

      <div class="hr"></div>

      <!-- RECAP -->
      <div class="box" id="orderBox">
        <h2 style="margin:0;font-size:16px;font-weight:1100;" data-i18n="order_title">ğŸ§¾ RÃ©cap paiement</h2>
        <p class="small" data-i18n="order_sub">VÃ©rifie ce que tu payes avant de confirmer.</p>
        <div class="hr"></div>
        <div class="row">
          <div>
            <div style="font-weight:1100;" data-i18n="order_product">Produit / Module</div>
            <div class="mono" style="font-weight:1000;" id="orderProduct">â€”</div>
          </div>
          <div>
            <div style="font-weight:1100;" data-i18n="order_plan">Plan</div>
            <div class="mono" style="font-weight:1000;" id="orderPlan">â€”</div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="row">
          <div>
            <div style="font-weight:1100;" data-i18n="order_amount">Montant</div>
            <div class="mono" style="font-weight:1000;" id="orderAmount">â€”</div>
          </div>
          <div>
            <div style="font-weight:1100;" data-i18n="order_ref">RÃ©fÃ©rence</div>
            <div class="mono" style="font-weight:1000;" id="orderRef">â€”</div>
          </div>
        </div>
        <p class="small" id="orderHint" style="margin-top:10px;"></p>
      </div>

      <div class="hr"></div>

      <!-- GRILLE TARIFS MENU CODIFIÃ‰ -->
      <div class="box" id="pricingBox">
        <h2 style="margin:0;font-size:16px;font-weight:1100;">ğŸ’° Menu CodifiÃ© â€” Dis le CODE, choisis ton pack</h2>
        <p class="small">Clique sur un tarif â†’ montant + code remplis automatiquement.</p>
        <div class="hr"></div>

        <!-- 1 Â· DRIVER -->
        <div class="section-sep">ğŸš— CODE 1 Â· DIGIY DRIVER</div>
        <div class="priceGrid" id="grid_driver"></div>

        <!-- 2 Â· LOC -->
        <div class="section-sep">ğŸ  CODE 2 Â· DIGIY LOC â€” Location</div>
        <div class="priceGrid" id="grid_loc"></div>

        <!-- 3 Â· RESTO -->
        <div class="section-sep">ğŸ½ï¸ CODE 3 Â· DIGIY RESTO PRO</div>
        <div class="priceGrid" id="grid_resto"></div>

        <!-- 4 Â· RÃ‰SA -->
        <div class="section-sep">ğŸ“… CODE 4 Â· DIGIY RÃ‰SA</div>
        <div class="priceGrid" id="grid_resa"></div>

        <!-- 5 Â· POS -->
        <div class="section-sep">ğŸ§¾ CODE 5 Â· DIGIY POS PRO</div>
        <div class="priceGrid" id="grid_pos"></div>

        <!-- 6 Â· MARKET -->
        <div class="section-sep">ğŸ›’ CODE 6 Â· DIGIY MARKET</div>
        <div class="priceGrid" id="grid_market"></div>

        <!-- 7 Â· BUILD -->
        <div class="section-sep">ğŸ—ï¸ CODE 7 Â· DIGIY BUILD</div>
        <div class="priceGrid" id="grid_build"></div>

        <!-- 8 Â· EXPLORE AGENCE -->
        <div class="section-sep">ğŸ§­ CODE 8 Â· DIGIY EXPLORE â€” Agence</div>
        <div class="priceGrid" id="grid_explore"></div>

        <!-- 9 Â· FRET CHAUFFEUR -->
        <div class="section-sep">ğŸšš CODE 9 Â· DIGIY FRET CHAUFFEUR</div>
        <div class="priceGrid" id="grid_fret_chauf"></div>

        <!-- 10 Â· FRET CLIENT -->
        <div class="section-sep">ğŸ“¦ CODE 10 Â· DIGIY FRET CLIENT</div>
        <div class="priceGrid" id="grid_fret_client"></div>

        <!-- E Â· EXPLORE BOOST -->
        <div class="section-sep">âœ¨ CODE E Â· BOOST EXPLORE (supplÃ©ment)</div>
        <div class="priceGrid" id="grid_boost"></div>

        <div class="hintLine" id="pricingHint">ğŸ“ Tu peux aussi commander par tÃ©lÃ©phone en disant juste le code : <strong>+221 77 134 28 89</strong></div>
      </div>

      <div class="hr"></div>

      <!-- TOKEN MODE -->
      <div class="box" id="tokenBox">
        <h2 style="margin:0;font-size:16px;font-weight:1100;" data-i18n="token_title">ğŸ” Activation sÃ©curisÃ©e</h2>
        <p class="small" data-i18n="token_desc">Si tu as reÃ§u un lien DIGIY avec token, clique simplement.</p>
        <div class="hr"></div>
        <button class="btn ok" id="btnActivateToken">
          <span data-i18n="btn_activate_now">âœ… Activer maintenant</span>
          <span id="spinnerToken" class="mono" style="display:none;margin-left:8px;">â³</span>
        </button>
        <p class="small" id="tokenHint" style="margin-top:10px;"></p>
      </div>

      <div class="hr"></div>

      <!-- MANUAL MODE -->
      <div class="box" id="manualBox">
        <h2 style="margin:0;font-size:16px;font-weight:1100;" data-i18n="manual_title">ğŸ’³ Paiement manuel (Wave)</h2>
        <p class="small" data-i18n="manual_desc">Paye sur Wave, puis envoie le reÃ§u sur WhatsApp. On active ensuite.</p>
        <div class="hr"></div>
        <div class="row">
          <div>
            <div style="font-weight:1100;">BÃ©nÃ©ficiaire</div>
            <div class="mono" style="font-weight:1000;">JB BEAUVILLE</div>
          </div>
          <div>
            <div style="font-weight:1100;">NumÃ©ro Wave</div>
            <div class="mono" style="font-weight:1000;" id="waveTo">+221 77 134 28 89</div>
          </div>
        </div>
        <div class="hr"></div>
        <ol class="steps">
          <li>Fais le transfert Wave</li>
          <li>Envoie le reÃ§u sur WhatsApp (avec le code choisi)</li>
          <li>Retourne au module â€” activation aprÃ¨s validation</li>
        </ol>
        <div class="hr"></div>
        <div class="row">
          <button class="btn gold" id="btnWaConfirm">ğŸ’¬ Confirmer WhatsApp (avec reÃ§u)</button>
          <button class="btn bad" id="btnSupport">ğŸ›Ÿ Support WhatsApp</button>
        </div>
        <p class="small" id="manualHint" style="margin-top:10px;"></p>
      </div>

      <div class="hide" id="dbg"></div>
    </div>
  </div>

  <script>
  (function(){
    "use strict";

    /* =====================================================
       GRILLE COMPLÃˆTE â€” MENU CODIFIÃ‰ V2
       AlignÃ©e 1:1 avec les tarifs officiels DIGIYLYFE
    ===================================================== */
    const PRICE_GROUPS = {
      driver: [
        { code:"1", plan:"DRIVER",        amount:12900,  label:"ğŸš— DRIVER",         desc:"GPS temps rÃ©el Â· Courses Â· Wave & OM" }
      ],
      loc: [
        { code:"2A", plan:"LOC_2A",       amount:12900,  label:"ğŸ¥‰ LOC 1-5 logements",  desc:"Pack essentiel propriÃ©taire" },
        { code:"2B", plan:"LOC_2B",       amount:25000,  label:"ğŸ¥ˆ LOC 6-9 logements",  desc:"Gestionnaire intermÃ©diaire" },
        { code:"2C", plan:"LOC_2C",       amount:45000,  label:"ğŸ¥‡ LOC 10-20 logements", desc:"Gestionnaire confirmÃ©" },
        { code:"2D", plan:"LOC_2D",       amount:60000,  label:"ğŸ’ LOC 21-30 logements", desc:"Grand propriÃ©taire" },
        { code:"2E", plan:"LOC_2E",       amount:90000,  label:"ğŸ‘‘ LOC 30+ logements",   desc:"Parc immobilier premium" }
      ],
      resto: [
        { code:"3A", plan:"RESTO_3A",     amount:19900,  label:"ğŸ¥‰ RESTO ESSENTIEL",  desc:"2 licences Â· 15 tables" },
        { code:"3B", plan:"RESTO_3B",     amount:39900,  label:"ğŸ¥ˆ RESTO STANDARD",   desc:"4 licences Â· 30 tables" },
        { code:"3C", plan:"RESTO_3C",     amount:59900,  label:"ğŸ¥‡ RESTO PRO",        desc:"6 licences Â· 45 tables" }
      ],
      resa: [
        { code:"4A", plan:"RESA_4A",      amount:12900,  label:"ğŸ¥‰ RÃ‰SA 1-5 tables",  desc:"Petite salle" },
        { code:"4B", plan:"RESA_4B",      amount:25000,  label:"ğŸ¥ˆ RÃ‰SA 6-9 tables",  desc:"Moyenne salle" },
        { code:"4C", plan:"RESA_4C",      amount:45000,  label:"ğŸ¥‡ RÃ‰SA 10-20 tables", desc:"Grande salle" },
        { code:"4D", plan:"RESA_4D",      amount:60000,  label:"ğŸ’ RÃ‰SA 21-30 tables", desc:"Salle Ã©vÃ©nementielle" },
        { code:"4E", plan:"RESA_4E",      amount:90000,  label:"ğŸ‘‘ RÃ‰SA 30+ tables",  desc:"Site multi-salles" }
      ],
      pos: [
        { code:"5",  plan:"POS_PRO",      amount:19900,  label:"ğŸ§¾ POS PRO",          desc:"Caisse tactile Â· Stock Â· Multi-users" }
      ],
      market: [
        { code:"6",  plan:"MARKET",       amount:19900,  label:"ğŸ›’ MARKET",           desc:"Boutique en ligne Â· Catalogue illimitÃ©" }
      ],
      build: [
        { code:"7",  plan:"BUILD",        amount:12900,  label:"ğŸ—ï¸ BUILD",            desc:"Artisans Â· Devis Â· Portfolio" }
      ],
      explore: [
        { code:"8A", plan:"EXPLORE_8A",   amount:30000,  label:"ğŸŸ¢ EXPLORE ESSENTIEL", desc:"VisibilitÃ© locale agence" },
        { code:"8B", plan:"EXPLORE_8B",   amount:60000,  label:"ğŸ”µ EXPLORE PRO",       desc:"VisibilitÃ© rÃ©gionale agence" },
        { code:"8C", plan:"EXPLORE_8C",   amount:120000, label:"ğŸŸ£ EXPLORE PREMIUM",   desc:"VisibilitÃ© internationale" },
        { code:"8D", plan:"EXPLORE_8D",   amount:150000, label:"ğŸ« EXPLORE SETUP",     desc:"Droit d'entrÃ©e one-shot Â· Onboarding", isOneShot:true }
      ],
      fret_chauf: [
        { code:"9A", plan:"FRET_CHAUF_9A", amount:25000,  label:"ğŸ¥‰ FRET LOCAL <50km",    desc:"Zone locale chauffeur" },
        { code:"9B", plan:"FRET_CHAUF_9B", amount:60000,  label:"ğŸ¥ˆ FRET RÃ‰GIONAL 50-200km", desc:"RÃ©gion chauffeur" },
        { code:"9C", plan:"FRET_CHAUF_9C", amount:120000, label:"ğŸ¥‡ FRET NATIONAL 200km+", desc:"National chauffeur" },
        { code:"9D", plan:"FRET_CHAUF_9D", amount:200000, label:"ğŸ‘‘ FRET INTERNATIONAL CEDEAO", desc:"CEDEAO chauffeur" }
      ],
      fret_client: [
        { code:"10A", plan:"FRET_CLI_10A", amount:9900,   label:"ğŸ¥‰ FRET CLIENT LOCAL",      desc:"ExpÃ©diteur zone locale" },
        { code:"10B", plan:"FRET_CLI_10B", amount:25000,  label:"ğŸ¥ˆ FRET CLIENT RÃ‰GIONAL",   desc:"ExpÃ©diteur rÃ©gional" },
        { code:"10C", plan:"FRET_CLI_10C", amount:60000,  label:"ğŸ¥‡ FRET CLIENT NATIONAL",   desc:"ExpÃ©diteur national" },
        { code:"10D", plan:"FRET_CLI_10D", amount:120000, label:"ğŸ‘‘ FRET CLIENT INTERNATIONAL", desc:"ExpÃ©diteur CEDEAO" }
      ],
      boost: [
        { code:"E1", plan:"BOOST_E1",     amount:5000,   label:"E1 Â· BOOST LOCAL",    desc:"Badge + vitrine locale + WhatsApp", isGold:true },
        { code:"E2", plan:"BOOST_E2",     amount:10000,  label:"E2 Â· BOOST STANDARD", desc:"Mise en avant + SEO + leads",       isGold:true },
        { code:"E3", plan:"BOOST_E3",     amount:20000,  label:"E3 Â· BOOST PREMIUM",  desc:"PrioritÃ© + support mÃ©dia + max visibilitÃ©", isGold:true }
      ]
    };

    /* ==================== CONFIG SUPABASE ==================== */
    const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const SUPPORT_WA = "+221771342889";
    const WAVE_TO    = "+221771342889";

    const $ = (id) => document.getElementById(id);
    const qp = new URLSearchParams(location.search);

    /* ==================== UTILS ==================== */
    function setStatus(text, tone, tag){
      const box = $("statusBox");
      box.className = "status " + (tone || "warn");
      $("statusText").textContent = text || "";
      const tg = $("statusTag");
      tg.className = "tag " + (tone || "warn");
      tg.textContent = tag || "â€”";
    }

    function wa(msg){
      const num = SUPPORT_WA.replace(/\+/g,"");
      location.href = "https://wa.me/" + num + "?text=" + encodeURIComponent(msg);
    }

    function normPhone(p){
      p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
      if(p.startsWith("00221")) p = "+221" + p.slice(5);
      if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
      if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
      return p;
    }

    function prettyFCFA(n){
      const x = String(n||"").replace(/[^\d]/g,"");
      if(!x || x === "0") return "";
      return Number(x).toLocaleString("fr-FR") + " FCFA";
    }

    /* ==================== URL PARAMS ==================== */
    const token  = (qp.get("token")  || "").trim();
    const ret    = (qp.get("return") || "").trim();
    const auto   = (qp.get("auto")   === "1");
    const phone  = normPhone(qp.get("phone") || "");
    const kind   = (qp.get("kind")   || "").trim().toLowerCase();
    const m      = (qp.get("m")      || "").trim();
    const slug   = (qp.get("slug")   || "").trim();
    const access = (qp.get("module") || "").trim().toUpperCase();
    const from_  = (qp.get("from")   || "").trim();

    let plan   = (qp.get("plan")   || "").trim();
    let amount = (qp.get("amount") || "").toString().replace(/[^\d]/g,"");
    let selectedCode = "";

    /* ==================== LANG (FR seulement ici, minimal) ==================== */
    let CURRENT_LANG = localStorage.getItem("digiy_lang") || "fr";

    document.getElementById("lang-fr").addEventListener("click", ()=>{
      CURRENT_LANG = "fr";
      localStorage.setItem("digiy_lang","fr");
      document.getElementById("lang-fr").classList.add("active");
      document.getElementById("lang-wo").classList.remove("active");
    });
    document.getElementById("lang-wo").addEventListener("click", ()=>{
      CURRENT_LANG = "wo";
      localStorage.setItem("digiy_lang","wo");
      document.getElementById("lang-wo").classList.add("active");
      document.getElementById("lang-fr").classList.remove("active");
    });

    /* ==================== RENDER PRICE GRIDS ==================== */
    function renderGrids(){
      const groups = {
        driver:      "grid_driver",
        loc:         "grid_loc",
        resto:       "grid_resto",
        resa:        "grid_resa",
        pos:         "grid_pos",
        market:      "grid_market",
        build:       "grid_build",
        explore:     "grid_explore",
        fret_chauf:  "grid_fret_chauf",
        fret_client: "grid_fret_client",
        boost:       "grid_boost"
      };

      for(const [groupKey, gridId] of Object.entries(groups)){
        const grid = $(gridId);
        if(!grid) continue;
        const items = PRICE_GROUPS[groupKey] || [];

        grid.innerHTML = items.map(p => {
          const isActive = (plan && plan === p.plan) || (amount && amount === String(p.amount) && p.amount > 0);
          const amtText = p.amount > 0 ? prettyFCFA(p.amount) : "Sur devis";
          const codeClass = p.isGold ? "priceCode gold" : "priceCode";
          const oneShotBadge = p.isOneShot ? '<span style="font-size:10px;color:var(--warn);margin-left:4px;">ONE-SHOT</span>' : "";
          return `
            <button class="priceBtn ${isActive ? "active" : ""}" type="button"
              data-plan="${p.plan}" data-amount="${p.amount}" data-code="${p.code}">
              <div class="priceTop">
                <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0;">
                  <div class="${codeClass}">${p.code}</div>
                  <div class="priceName">${p.label}${oneShotBadge}</div>
                </div>
                <div class="priceAmt">${amtText}</div>
              </div>
              <div class="priceDesc">${p.desc}</div>
            </button>
          `;
        }).join("");

        grid.querySelectorAll(".priceBtn").forEach(btn => {
          btn.addEventListener("click", () => {
            const pPlan   = (btn.getAttribute("data-plan")   || "").trim();
            const pAmt    = (btn.getAttribute("data-amount") || "").trim();
            const pCode   = (btn.getAttribute("data-code")   || "").trim();

            if(pAmt && pAmt !== "0") amount = pAmt;
            if(pPlan) plan = pPlan;
            selectedCode = pCode;

            // Update URL (shareable)
            const u = new URL(location.href);
            if(plan)  u.searchParams.set("plan", plan);
            if(amount) u.searchParams.set("amount", amount);
            history.replaceState(null, "", u.toString());

            renderGrids();
            renderOrder();
            setStatus("ğŸ’³ Code " + pCode + " sÃ©lectionnÃ© â€” paye sur Wave & envoie le reÃ§u.", "warn", "CODE " + pCode);
          });
        });
      }
    }

    /* ==================== RENDER ORDER RECAP ==================== */
    function getProductLabel(){
      // Try to derive a nice label from plan code
      if(selectedCode) return "DIGIY Â· Code " + selectedCode;
      return (access || m || "DIGIY");
    }

    function renderOrder(){
      const product = getProductLabel();
      const planTxt = plan || "â€”";
      const amt = prettyFCFA(amount) || "â€”";
      const ref = slug || selectedCode || (token ? ("token:" + token.slice(0,8) + "â€¦") : "â€”");

      $("orderProduct").textContent = product;
      $("orderPlan").textContent = planTxt;
      $("orderAmount").textContent = amt;
      $("orderRef").textContent = ref;

      const missing = (!amount || !plan);
      $("orderHint").textContent = missing
        ? "âš ï¸ Choisis un tarif dans la grille ci-dessous."
        : "âœ… Tout est bon. Tu peux payer et envoyer le reÃ§u sur WhatsApp.";
    }

    // Initial render
    renderGrids();
    renderOrder();

    /* ==================== TOKEN MODE ==================== */
    if(!token){
      $("tokenBox").classList.add("hide");
      setStatus("ğŸ’³ Paiement Wave Â· Choisis ton code", "warn", "MANUEL");
      $("manualHint").textContent = "SÃ©lectionne un code dans la grille â†’ le montant apparaÃ®t ici.";
    } else {
      setStatus("ğŸ” Lien sÃ©curisÃ© dÃ©tectÃ©. Clique pour activer.", "ok", "TOKEN");
      $("tokenHint").textContent = "Token dÃ©tectÃ©. Activation en 1 clic.";
    }

    async function activateToken(){
      if(!token){ alert("Token manquant."); return; }
      $("btnActivateToken").disabled = true;
      $("spinnerToken").style.display = "inline-block";
      setStatus("â³ Activation en coursâ€¦", "warn", "EN COURS");
      try{
        const { data, error } = await sb.rpc("digiy_pay_activate_token", { p_token: token });
        if(error) throw error;
        if(!data?.ok) throw new Error(data?.reason || "activation_failed");
        setStatus("ğŸŸ¢ ActivÃ© ! Tu peux continuer.", "ok", "ACTIF");
        if(ret){
          const u = new URL(ret, location.origin);
          u.searchParams.set("from", "digiy-pay-token");
          location.href = u.toString();
        } else {
          $("tokenHint").textContent = "Activation OK. Tu peux fermer cette page.";
        }
      } catch(e){
        setStatus("ğŸ”´ Activation impossible. Contacte le support.", "bad", "ERREUR");
        $("tokenHint").textContent = String(e.message || e);
      } finally {
        $("spinnerToken").style.display = "none";
        $("btnActivateToken").disabled = false;
      }
    }

    $("btnActivateToken").addEventListener("click", activateToken);
    if(auto && token) setTimeout(activateToken, 400);

    /* ==================== WHATSAPP CONFIRM ==================== */
    $("btnWaConfirm").addEventListener("click", function(){
      if(!amount){
        setStatus("âš ï¸ Choisis un tarif dans la grille d'abord.", "warn", "TARIF");
        return;
      }
      let msg = "DIGIY â€” Confirmation paiement Wave\n\n";
      msg += "BÃ©nÃ©ficiaire: JB BEAUVILLE\n";
      msg += "Wave: " + WAVE_TO + "\n\n";
      if(phone)        msg += "TÃ©lÃ©phone: " + phone + "\n";
      if(selectedCode) msg += "Code menu: " + selectedCode + "\n";
      if(access)       msg += "AccÃ¨s: " + access + "\n";
      if(kind)         msg += "Type: " + kind + "\n";
      msg += "Produit: " + getProductLabel() + "\n";
      if(plan)         msg += "Plan: " + plan + "\n";
      msg += "Montant: " + amount + " FCFA\n";
      if(slug)         msg += "Slug: " + slug + "\n";
      if(token)        msg += "Token: " + token + "\n";
      msg += "\nJe joins le reÃ§u Wave ici.\nMerci d'activer. â€” DIGIY";
      wa(msg);
      setStatus("âœ… Message WhatsApp prÃªt. Ajoute le reÃ§u.", "warn", "EN ATTENTE");
    });

    $("btnSupport").addEventListener("click", function(){
      let msg = "DIGIY â€” Support Paiement\n\n";
      if(phone)        msg += "TÃ©lÃ©phone: " + phone + "\n";
      if(selectedCode) msg += "Code menu: " + selectedCode + "\n";
      msg += "Produit: " + getProductLabel() + "\n";
      if(plan)   msg += "Plan: " + plan + "\n";
      if(amount) msg += "Montant: " + amount + " FCFA\n";
      if(slug)   msg += "Slug: " + slug + "\n";
      msg += "\nJ'ai besoin d'aide. â€” DIGIY";
      wa(msg);
      setStatus("ğŸ’¬ Support WhatsAppâ€¦", "warn", "INFO");
    });

    if(from_) $("manualHint").textContent = "AprÃ¨s activation, retourne sur ton module.";

  })();
  </script>
</body>
</html>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY PRO â€¢ Paiement & Activation</title>
  <meta name="theme-color" content="#16a34a"/>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px; --shadow:0 18px 50px rgba(0,0,0,.35);
      --gold:#facc15;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    h1{ margin:0; font-size:20px; font-weight:1100; letter-spacing:.2px; }
    h2{ margin:0; font-size:16px; font-weight:1100; }
    p{ margin:8px 0 0; color:var(--muted); line-height:1.35; }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid var(--line); border-radius:999px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .small{ font-size:13px; color:var(--muted); line-height:1.35; }
    .hr{ height:1px; background:var(--line); margin:12px 0; }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    @media(min-width:980px){ .grid{ grid-template-columns:1.03fr .97fr; } }

    .statusBig{
      margin-top:12px; padding:12px; border-radius:16px;
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-weight:1100;
    }
    .statusBig.ok{ border-color: rgba(34,197,94,.55); }
    .statusBig.warn{ border-color: rgba(245,158,11,.55); }
    .statusBig.bad{ border-color: rgba(239,68,68,.55); }

    .tag{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .tag.ok{ color: var(--ok); border-color: rgba(34,197,94,.45); }
    .tag.warn{ color: var(--warn); border-color: rgba(245,158,11,.45); }
    .tag.bad{ color: var(--bad); border-color: rgba(239,68,68,.45); }

    .btn{
      border:1px solid var(--line); background:transparent; color:var(--text);
      padding:12px 14px; border-radius:16px; cursor:pointer; font-weight:1100;
      min-height:52px; width:100%;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.ok{ border-color: rgba(34,197,94,.55); }
    .btn.warn{ border-color: rgba(245,158,11,.55); }
    .btn.bad{ border-color: rgba(239,68,68,.55); }
    .btn.gold{ border-color: rgba(250,204,21,.65); }

    .box{ border:1px solid var(--line); border-radius:16px; padding:12px; background:rgba(0,0,0,.12); }
    .cards{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:740px){ .cards{ grid-template-columns:repeat(2,1fr); } }

    .plan{
      border:1px solid var(--line); border-radius:16px; padding:12px;
      background:rgba(0,0,0,.10);
      display:flex; flex-direction:column; gap:10px;
    }
    .planHead{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted);
      white-space:nowrap;
    }
    .badge.pop{ border-color:rgba(250,204,21,.55); color:var(--gold); }
    .price{ font-size:18px; font-weight:1200; }
    .list{ margin:0; padding-left:18px; color:var(--muted); font-size:13px; line-height:1.35; }
    .list li{ margin:4px 0; }
    .actions2{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media(min-width:560px){ .actions2{ grid-template-columns:1fr 1fr; } }

    .selectLine{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .k{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
        font-size:12px; padding:2px 6px; border:1px solid var(--line); border-radius:8px; color:var(--muted);
        background:rgba(0,0,0,.12);
    }

    .qr-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .qr-container {
      background: #fff;
      border-radius: 24px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      animation: slideUp 0.4s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .qr-container h2 {
      color: #000;
      margin: 0 0 20px;
      font-size: 24px;
    }
    .qr-image {
      width: 300px;
      height: 300px;
      margin: 20px auto;
      border: 3px solid #22c55e;
      border-radius: 16px;
      padding: 10px;
      background: #fff;
    }
    .qr-amount {
      font-size: 36px;
      font-weight: 900;
      color: #facc15;
      margin: 20px 0;
    }
    .qr-details {
      color: #666;
      font-size: 14px;
      margin: 10px 0;
      font-weight: 900;
    }
    .qr-status {
      background: #f0fdf4;
      border: 2px solid #22c55e;
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
    }
    .qr-status-text {
      color: #16a34a;
      font-weight: 900;
      font-size: 16px;
    }
    .qr-status-sub {
      color: #666;
      font-size: 12px;
      margin-top: 5px;
    }
    .qr-btn-close {
      width: 100%;
      padding: 15px;
      background: #ef4444;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-weight: 900;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    .qr-btn-close:hover {
      background: #dc2626;
    }
    .qr-instructions {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 12px;
      padding: 15px;
      margin: 15px 0;
      color: #92400e;
      font-weight: 900;
      font-size: 13px;
    }

    input[type="text"], input[type="email"] {
      padding: 14px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: rgba(0,0,0,.12);
      color: var(--text);
      font-size: 15px;
      font-weight: 500;
      width: 100%;
    }
    input[type="text"]:focus, input[type="email"]:focus {
      outline: none;
      border-color: var(--ok);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <h1>DIGIY PRO</h1>
          <p class="small"><b>0% Commission</b> Â· Paiement Direct</p>
        </div>
        <div class="row">
          <span class="pill">ğŸ“¦ accÃ¨s: <span class="mono" id="pillAccess">â€”</span></span>
          <span class="pill">ğŸ“¦ choisi: <span class="mono" id="pillModule">â€”</span></span>
          <span class="pill">ğŸ“± phone: <span class="mono" id="pillPhone">â€”</span></span>
          <span class="pill">ğŸ·ï¸ slug: <span class="mono" id="pillSlug">â€”</span></span>
        </div>
      </div>

      <div class="hr"></div>

      <div>
        <h2>â„¹ï¸ Paiement & Activation DIGIY</h2>
        <p class="small">
          Effectue d'abord le paiement via <b>Wave</b>, puis confirme sur <b>WhatsApp</b>.
          (Cette page sait revenir automatiquement au planning)
        </p>
      </div>

      <div class="statusBig warn" id="statusBig">
        <div id="statusText">â³ VÃ©rification du statutâ€¦</div>
        <span class="tag warn" id="tag">EN COURS</span>
      </div>

      <!-- ğŸ‘¤ SECTION INFOS CLIENT -->
      <div class="card" id="clientInfoBox" style="margin-top:16px; display:none;">
        <h2>ğŸ‘¤ Tes informations</h2>
        <p class="small">Pour bien enregistrer ton abonnement dans la caisse DIGIYLYFE</p>
        
        <div class="hr"></div>
        
        <div style="display:grid; gap:12px;">
          <input type="text" id="inputPrenom" placeholder="PrÃ©nom *">
          <input type="text" id="inputNom" placeholder="Nom *">
          <input type="email" id="inputEmail" placeholder="Email (optionnel)">
        </div>
        
        <div class="hr"></div>
        
        <button class="btn ok" id="btnSaveInfo">âœ… Valider mes infos</button>
        
        <p class="small" style="margin-top:8px; color:var(--muted);">
          * Champs obligatoires Â· Ces infos sont enregistrÃ©es pour ton abonnement
        </p>
      </div>

      <div class="grid">
        <div class="box">
          <h2>ğŸ’³ Paiement via Wave</h2>
          <p class="small">Scanne le QR avec ton app Wave :</p>

          <div class="hr"></div>

          <div class="selectLine">
            <div>
              <div style="font-weight:1200;">ğŸ“± JB BEAUVILLE</div>
              <div class="mono" style="font-weight:1100;">+221 77 134 28 89</div>
              <div class="small">Montant = prix du module choisi</div>
            </div>
            <div class="pill">Montant: <span class="mono" id="pillAmount">â€”</span></div>
          </div>

          <div class="hr"></div>

          <h2>ğŸ’¬ Confirmation WhatsApp</h2>
          <p class="small">
            AprÃ¨s le paiement, envoie : âœ… le reÃ§u Wave âœ… le module/pack choisi
          </p>

          <div class="hr"></div>

          <div style="font-weight:1200;">ğŸ“Œ RÃ©sumÃ© automatique</div>
          <div class="small">
            ğŸ“¦ accÃ¨s: <span class="mono" id="sumAccess">â€”</span><br/>
            ğŸ“¦ module: <span class="mono" id="sumModule">â€”</span><br/>
            ğŸ“± phone: <span class="mono" id="sumPhone">â€”</span><br/>
            ğŸ·ï¸ slug: <span class="mono" id="sumSlug">â€”</span><br/>
            ğŸ§¾ plan: <span class="mono" id="sumPlan">â€”</span><br/>
            ğŸ’° montant: <span class="mono" id="sumAmount">â€”</span>
          </div>

          <div class="hr"></div>

          <div class="actions2">
            <button class="btn gold" id="btnPayNow">âš¡ Payer maintenant (Wave QR)</button>
            <button class="btn warn" id="btnWaConfirm">ğŸ’¬ Confirmer sur WhatsApp</button>
          </div>

          <div style="height:10px;"></div>

          <div class="actions2">
            <button class="btn warn" id="btnRefresh">ğŸ”„ RafraÃ®chir statut</button>
            <button class="btn ok" id="btnBack" disabled>âœ… Retour au planning</button>
          </div>

          <div style="height:10px;"></div>

          <button class="btn bad" id="btnHelp">ğŸ’¬ Support WhatsApp</button>

          <div class="small" id="hint" style="margin-top:10px;"></div>

          <div class="hr"></div>

          <div class="small">
            ğŸ”¥ <b>Nouveau :</b> Paiement automatique avec QR Wave ! Le statut se met Ã  jour en temps rÃ©el.
          </div>
        </div>

        <div class="box">
          <h2>Choisis ton module PRO ğŸ¦…</h2>
          <p class="small">
            Abonnement Â· 0% commission sur tes revenus Â· Tu gardes 100% de ce que tu gagnes
          </p>
          <p class="small">
            âœ“ Paiement direct Wave âœ“ Activation rapide âœ“ Made in SÃ©nÃ©gal
          </p>

          <div class="hr"></div>

          <div class="plan">
            <div class="planHead">
              <div>
                <div style="font-weight:1200;">ğŸ½ï¸ DIGIY RESTO PRO</div>
                <div class="small">
                  Gestion restaurant complÃ¨te â€¢ Plan de salle â€¢ Commandes â€¢ KDS â€¢ Caisse â€¢ Offline
                </div>
              </div>
              <span class="badge pop">PRO</span>
            </div>

            <div class="small"><b>Par nombre de licences</b></div>

            <div class="small">ğŸ¥‰ ESSENTIEL â€¢ 2 licences (15 tables)</div>
            <div class="price">9,900 F / mois</div>
            <button class="btn gold" data-choose="RESTO_PRO" data-plan="RESTO_PRO_ESSENTIEL" data-amount="9900">
              Choisir ESSENTIEL
            </button>

            <div class="hr"></div>

            <div class="small">ğŸ¥ˆ STANDARD â€¢ 4 licences (30 tables)</div>
            <div class="price">14,900 F / mois</div>
            <button class="btn gold" data-choose="RESTO_PRO" data-plan="RESTO_PRO_STANDARD" data-amount="14900">
              Choisir STANDARD
            </button>

            <div class="hr"></div>

            <div class="small">ğŸ¥‡ PRO â€¢ 6 licences (45 tables)</div>
            <div class="price">24,900 F / mois</div>
            <button class="btn gold" data-choose="RESTO_PRO" data-plan="RESTO_PRO_FULL" data-amount="24900">
              Choisir PRO
            </button>

            <ul class="list">
              <li>Plan de salle interactif</li>
              <li>Prise de commande multi-zones</li>
              <li>Kitchen Display System (KDS)</li>
              <li>Caisse + imprimante thermique</li>
              <li>Mode hors ligne</li>
              <li>âœ… 0% commission</li>
            </ul>
          </div>

          <div class="hr"></div>

          <div class="plan">
            <div class="planHead">
              <div>
                <div style="font-weight:1200;">ğŸ“… DIGIY RÃ‰SA</div>
                <div class="small">
                  RÃ©servations restaurant â€¢ Planning temps rÃ©el â€¢ SMS auto â€¢ Gestion tables
                </div>
              </div>
              <span class="badge">0% commission</span>
            </div>

            <div class="small"><b>Par nombre de tables</b></div>

            <button class="btn gold" data-choose="RESTO_RESA" data-plan="RESA_1_5" data-amount="9900">
              ğŸ¥‰ 1â€“5 tables â€” 9,900 F
            </button>
            <button class="btn gold" data-choose="RESTO_RESA" data-plan="RESA_6_9" data-amount="15000">
              ğŸ¥ˆ 6â€“9 tables â€” 15,000 F
            </button>
            <button class="btn gold" data-choose="RESTO_RESA" data-plan="RESA_10_20" data-amount="25000">
              ğŸ¥‡ 10â€“20 tables â€” 25,000 F
            </button>
            <button class="btn gold" data-choose="RESTO_RESA" data-plan="RESA_21_30" data-amount="30000">
              ğŸ’ 21â€“30 tables â€” 30,000 F
            </button>
            <button class="btn gold" data-choose="RESTO_RESA" data-plan="RESA_30P" data-amount="50000">
              ğŸ‘‘ 30+ tables â€” 50,000 F
            </button>

            <ul class="list">
              <li>RÃ©servations en ligne</li>
              <li>Planning temps rÃ©el</li>
              <li>Notifications SMS / WhatsApp</li>
              <li>Gestion des tables</li>
              <li>âœ… 0% commission</li>
            </ul>
          </div>

          <div class="hr"></div>

          <div class="plan">
            <div class="planHead">
              <div>
                <div style="font-weight:1200;">ğŸ§¾ DIGIY POS PRO</div>
                <div class="small">
                  Caisse enregistreuse pro â€¢ Gestion stock â€¢ Ventes â€¢ Stats â€¢ Multi-utilisateurs
                </div>
              </div>
              <span class="badge pop">â­ PRO</span>
            </div>

            <div class="price">12,900 F / mois</div>
            <button class="btn gold" data-choose="POS_PRO" data-plan="POS_PRO_MONTHLY" data-amount="12900">
              Choisir POS PRO
            </button>

            <ul class="list">
              <li>Caisse tactile intuitive</li>
              <li>Gestion stock</li>
              <li>Statistiques temps rÃ©el</li>
              <li>Multi-utilisateurs + droits</li>
              <li>Imprimante thermique 80mm</li>
              <li>Mode hors ligne</li>
              <li>âœ… 0% commission</li>
            </ul>
          </div>

          <div class="hr"></div>

          <h2>ğŸ“¦ Autres modules individuels</h2>

          <div class="cards">
            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸš— DIGIY DRIVER</div>
                  <div class="small">VTC sans commission Â· Paiement direct aux chauffeurs</div>
                </div>
                <span class="badge">Prix fixe</span>
              </div>
              <div class="price">9,900 F / mois</div>
              <button class="btn gold" data-choose="DRIVER" data-plan="DRIVER_MONTHLY" data-amount="9900">
                Choisir DRIVER
              </button>
            </div>

            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸ  DIGIY LOC</div>
                  <div class="small">Location courte durÃ©e Â· Calendrier Â· RÃ©servations Â· 0% commission</div>
                </div>
                <span class="badge">Par logements</span>
              </div>
              <div class="small">
                1â€“5 : <b>9,900</b> F Â· 6â€“9 : <b>15,000</b> F Â· 10â€“20 : <b>25,000</b> F<br/>
                21â€“30 : <b>30,000</b> F Â· 30+ : <b>50,000</b> F
              </div>
              <div style="height:10px;"></div>
              <div class="row">
                <button class="btn gold" data-choose="LOC" data-plan="LOC_1_5" data-amount="9900">1â€“5</button>
                <button class="btn gold" data-choose="LOC" data-plan="LOC_6_9" data-amount="15000">6â€“9</button>
                <button class="btn gold" data-choose="LOC" data-plan="LOC_10_20" data-amount="25000">10â€“20</button>
                <button class="btn gold" data-choose="LOC" data-plan="LOC_21_30" data-amount="30000">21â€“30</button>
                <button class="btn gold" data-choose="LOC" data-plan="LOC_30P" data-amount="50000">30+</button>
              </div>
            </div>

            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸ›’ DIGIY MARKET</div>
                  <div class="small">Marketplace â€¢ Vente en ligne â€¢ Catalogue â€¢ Paiement mobile</div>
                </div>
                <span class="badge">Prix fixe</span>
              </div>
              <div class="price">12,900 F / mois</div>
              <button class="btn gold" data-choose="MARKET" data-plan="MARKET_MONTHLY" data-amount="12900">
                Choisir MARKET
              </button>
            </div>

            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸ’¼ DIGIY JOBS</div>
                  <div class="small">Emploi & recrutement Â· Offres Â· CV</div>
                </div>
                <span class="badge">Prix fixe</span>
              </div>
              <div class="price">7,900 F / mois</div>
              <button class="btn gold" data-choose="JOBS" data-plan="JOBS_MONTHLY" data-amount="7900">
                Choisir JOBS
              </button>
            </div>

            <div class="plan">
              <div class="planHead">
                <div>
                  <div style="font-weight:1200;">ğŸ—ï¸ DIGIY BUILD</div>
                  <div class="small">Services construction Â· Devis Â· Planning</div>
                </div>
                <span class="badge">Prix fixe</span>
              </div>
              <div class="price">9,900 F / mois</div>
              <button class="btn gold" data-choose="BUILD" data-plan="BUILD_MONTHLY" data-amount="9900">
                Choisir BUILD
              </button>
            </div>
          </div>

          <div class="hr"></div>
          <div class="small">Â© DIGIYLYFE â€” Made in SÃ©nÃ©gal ğŸ‡¸ğŸ‡³ Â· 0% commission Â· Paiement direct Â· SouverainetÃ© digitale</div>
        </div>
      </div>
    </div>
  </div>

  <div class="qr-modal" id="qrModal">
    <div class="qr-container">
      <h2>ğŸ“± Scanner pour payer</h2>
      
      <img id="qrImage" src="" alt="QR Code" class="qr-image" />
      
      <div class="qr-amount" id="qrAmount">â€”</div>
      
      <div class="qr-details">
        <div id="qrModule">Module: â€”</div>
        <div id="qrPlan">Plan: â€”</div>
      </div>

      <div class="qr-instructions">
        ğŸ“± Ouvre ton app <b>Wave</b><br/>
        ğŸ‘‰ Scanne ce QR code<br/>
        âœ… Confirme le paiement
      </div>
      
      <div class="qr-status">
        <div class="qr-status-text">â³ En attente du paiement...</div>
        <div class="qr-status-sub">Le statut se met Ã  jour automatiquement</div>
      </div>
      
      <button class="qr-btn-close" onclick="closeQRModal()">
        âŒ Annuler
      </button>
    </div>
  </div>

  <script>
    (function(){
      "use strict";
      
      const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const SUPPORT_WA = "+221771342889";
      const RECIPIENT_WAVE = "+221771342889";
      
      const $ = function(id){ return document.getElementById(id); };
      let pollingInterval = null;

      function qs(name){
        try{ return new URL(location.href).searchParams.get(name) || ""; }catch(e){ return ""; }
      }
      
      function setQS(name, value){
        const u = new URL(location.href);
        if(value === null || value === undefined || value === "") u.searchParams.delete(name);
        else u.searchParams.set(name, value);
        history.replaceState({}, "", u.toString());
      }
      
      function fmt(n){
        n = Number(n||0);
        if(!isFinite(n) || n<=0) return "â€”";
        return n.toLocaleString("fr-FR");
      }

      function normPhone(p){
        p = String(p||"").trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");
        if(p.startsWith("00221")) p = "+221" + p.slice(5);
        if(!p.startsWith("+") && p.startsWith("221")) p = "+" + p;
        if(!p.startsWith("+221") && /^\d{9}$/.test(p)) p = "+221" + p;
        return p;
      }

      function wa(msg){
        location.href = "https://wa.me/" + SUPPORT_WA.replace(/\+/g,"") + "?text=" + encodeURIComponent(msg);
      }

      const from = (qs("from") || "").trim();
      const slug = (qs("slug") || "").trim();
      const phone = normPhone(qs("phone") || "");
      const accessModule = String(qs("module") || "").trim().toUpperCase();
      let status = (qs("status") || "").trim().toLowerCase();
      let chosenModule = (qs("m") || "").trim().toUpperCase();
      let chosenPlan = (qs("plan") || "").trim();
      let chosenAmount = (qs("amount") || "").trim();

      $("pillAccess").textContent = accessModule || "â€”";
      $("pillModule").textContent = chosenModule || "â€”";
      $("pillPhone").textContent = phone || "â€”";
      $("pillSlug").textContent = slug || "â€”";

      function syncSummary(){
        $("sumAccess").textContent = accessModule || "â€”";
        $("sumModule").textContent = chosenModule || "â€”";
        $("sumPhone").textContent = phone || "â€”";
        $("sumSlug").textContent = slug || "â€”";
        $("sumPlan").textContent = chosenPlan || "â€”";
        $("sumAmount").textContent = chosenAmount ? (fmt(chosenAmount) + " F") : "â€”";
        $("pillAmount").textContent = chosenAmount ? (fmt(chosenAmount) + " F") : "â€”";
        $("pillModule").textContent = chosenModule || "â€”";
      }
      syncSummary();

      function setHint(msg){ $("hint").textContent = msg || ""; }
      
      function setBig(text, tone, tagText){
        const el = $("statusBig");
        el.className = "statusBig " + (tone || "warn");
        $("statusText").textContent = text;
        const tag = $("tag");
        tag.className = "tag " + (tone || "warn");
        tag.textContent = tagText || "â€”";
      }

      function safeBack(){
        if(from){ location.replace(from); return; }
        location.replace("https://beauville.github.io/digiy-loc-pro/login.html" + (slug ? "?slug="+encodeURIComponent(slug) : ""));
      }

      function ensureChoice(){
        if(!phone){
          setHint("TÃ©lÃ©phone manquant.");
          return false;
        }
        if(!chosenModule){
          setHint("Choisis un module.");
          return false;
        }
        if(!chosenAmount){
          setHint("Choisis un tarif.");
          return false;
        }
        return true;
      }

      function pick(mod, plan, amount){
        chosenModule = String(mod||"").trim().toUpperCase();
        chosenPlan = String(plan||"").trim();
        chosenAmount = String(amount||"").trim();

        setQS("m", chosenModule);
        setQS("plan", chosenPlan);
        setQS("amount", chosenAmount);

        syncSummary();
        setHint("Choix enregistrÃ©.");
      }

      document.querySelectorAll("[data-choose]").forEach(function(btn){
        btn.addEventListener("click", function(){
          pick(btn.getAttribute("data-choose"), btn.getAttribute("data-plan"), btn.getAttribute("data-amount"));
        });
      });

      function showPaymentQR(params) {
        const modal = $("qrModal");
        const qrImage = $("qrImage");
        const qrAmount = $("qrAmount");
        const qrModule = $("qrModule");
        const qrPlan = $("qrPlan");

        const qrCode = params.qrCode;
        if (qrCode.startsWith('data:image') || qrCode.startsWith('http')) {
          qrImage.src = qrCode;
        } else {
          qrImage.src = "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" + encodeURIComponent(qrCode);
        }

        qrAmount.textContent = fmt(params.amount) + ' F CFA';
        qrModule.textContent = 'Module: ' + params.module;
        qrPlan.textContent = 'Plan: ' + params.plan;

        modal.style.display = 'flex';
        
        startPaymentPolling(params.paymentId);
      }

      window.closeQRModal = function() {
        $("qrModal").style.display = 'none';
        if (pollingInterval) clearInterval(pollingInterval);
        $("btnPayNow").disabled = false;
      };

      async function startPaymentPolling(paymentId) {
        if (pollingInterval) clearInterval(pollingInterval);
        
        pollingInterval = setInterval(async function(){
          try {
            const result = await sb.rpc("digiy_pay_check_status", {
              p_payment_id: paymentId
            });

            const data = result.data;
            const error = result.error;

            if (error) throw error;

            if (data.status === 'completed') {
              clearInterval(pollingInterval);
              closeQRModal();
              
              setBig("Paiement confirmÃ©!", "ok", "PAYÃ‰");
              setHint("Activation en cours...");
              
              setTimeout(function(){
                checkStatus(true);
              }, 2000);
            }

            if (data.status === 'failed') {
              clearInterval(pollingInterval);
              closeQRModal();
              setBig("Paiement Ã©chouÃ©", "bad", "Ã‰CHEC");
              setHint("RÃ©essaie ou contacte le support.");
            }

          } catch(e) {
            console.error('Polling error:', e);
          }
        }, 3000);

        setTimeout(function(){
          if (pollingInterval) {
            clearInterval(pollingInterval);
            closeQRModal();
            setBig("Temps Ã©coulÃ©", "warn", "TIMEOUT");
            setHint("Paiement non dÃ©tectÃ©. VÃ©rifie ton compte Wave.");
          }
        }, 600000);
      }

      // BOUTON PAYER MAINTENANT - AVEC CAISSE CENTRALE
      $("btnPayNow").onclick = async function(){
        if(!ensureChoice()) return;

        // VÃ©rifier si les infos client sont remplies
        const prenom = localStorage.getItem('digiy_prenom') || '';
        const nom = localStorage.getItem('digiy_nom') || '';
        
        if(!prenom || !nom) {
          $("clientInfoBox").style.display = 'block';
          $("clientInfoBox").scrollIntoView({ behavior: 'smooth', block: 'center' });
          setHint("ğŸ‘† Remplis tes infos d'abord frÃ©rot!");
          return;
        }

        try {
          setBig("ğŸ”„ Enregistrement caisse centrale...", "warn", "EN COURS");
          $("btnPayNow").disabled = true;

          // 1ï¸âƒ£ ENREGISTRER dans la CAISSE CENTRALE
          console.log("ğŸ“ Enregistrement encaissement...");
          
          const encaissement = await sb.rpc("digiy_caisse_enregistrer", {
            p_phone: phone,
            p_module: chosenModule,
            p_plan: chosenPlan,
            p_montant: parseInt(chosenAmount),
            p_nom: nom,
            p_prenom: prenom,
            p_email: localStorage.getItem('digiy_email') || null,
            p_access_module: accessModule,
            p_slug: slug,
            p_metadata: {
              user_agent: navigator.userAgent,
              timestamp: new Date().toISOString(),
              page_url: location.href
            }
          });

          if(encaissement.error) throw encaissement.error;
          
          const encaissementId = encaissement.data.id;
          console.log("âœ… Encaissement enregistrÃ©:", encaissementId);

          // 2ï¸âƒ£ CRÃ‰ER le paiement WAVE
          setBig("ğŸ’³ CrÃ©ation du paiement Wave...", "warn", "EN COURS");
          
          const metaObj = {
            encaissement_id: encaissementId,
            access_module: accessModule,
            chosen_module: chosenModule,
            chosen_plan: chosenPlan,
            slug: slug,
            phone: phone,
            nom: nom,
            prenom: prenom
          };

          const result = await sb.rpc("digiy_pay_create_request", {
            p_module: "subscription",
            p_module_ref_id: encaissementId,
            p_amount_fcfa: parseInt(chosenAmount),
            p_payer_phone: phone,
            p_recipient_phone: RECIPIENT_WAVE,
            p_provider: "wave",
            p_description: "DIGIY PRO - " + chosenModule + " - " + chosenPlan + " - " + prenom + " " + nom,
            p_metadata: JSON.stringify(metaObj)
          });

          const data = result.data;
          const error = result.error;

          if (error) throw error;
          if (!data.ok) throw new Error(data.reason || "payment_creation_failed");

          const paymentId = data.id;
          console.log("âœ… Paiement crÃ©Ã©:", paymentId);

          // 3ï¸âƒ£ LIER payment_id Ã  l'encaissement
          await sb.from('encaissements_digiylyfe')
            .update({ payment_id: paymentId })
            .eq('id', encaissementId);

          setBig("âœ… QR gÃ©nÃ©rÃ©!", "ok", "PRÃŠT");
          
          showPaymentQR({
            paymentId: paymentId,
            encaissementId: encaissementId,
            qrCode: data.qr_code || data.payment_link,
            amount: chosenAmount,
            module: chosenModule,
            plan: chosenPlan
          });

        } catch(e) {
          console.error("âŒ Erreur:", e);
          setBig("âŒ Erreur", "bad", "ERREUR");
          setHint("Erreur: " + (e.message || e));
          $("btnPayNow").disabled = false;
        }
      };

      $("btnWaConfirm").onclick = function(){
        if(!ensureChoice()) return;

        var msg = "DIGIY PRO - Confirmation paiement Wave\n\n";
        msg += "BÃ©nÃ©ficiaire: JB BEAUVILLE\n";
        msg += "Wave: " + SUPPORT_WA + "\n\n";
        msg += "AccÃ¨s: " + (accessModule || "LOC") + "\n";
        msg += "Produit: " + chosenModule + "\n";
        msg += "Plan: " + (chosenPlan || "â€”") + "\n";
        msg += "Montant: " + fmt(chosenAmount) + " F CFA\n";
        msg += "TÃ©lÃ©phone: " + (phone || "â€”") + "\n";
        msg += "Slug: " + (slug || "â€”") + "\n\n";
        msg += "Je viens de payer via Wave.\n";
        msg += "Je joins le reÃ§u Wave ici.\n\n";
        msg += "Merci d'activer mon accÃ¨s. â€” DIGIY";
        
        wa(msg);
        
        status = "pending";
        setQS("status", "pending");
        setBig("Confirmation envoyÃ©e.", "warn", "EN ATTENTE");
        setHint("Envoie le reÃ§u Wave.");
      };

      $("btnHelp").onclick = function(){
        var msg = "DIGIY PRO - Support\n\n";
        msg += "AccÃ¨s: " + (accessModule || "LOC") + "\n";
        msg += "Produit: " + (chosenModule || "â€”") + "\n";
        msg += "Plan: " + (chosenPlan || "â€”") + "\n";
        msg += "Montant: " + (chosenAmount ? (fmt(chosenAmount)+" F") : "â€”") + "\n";
        msg += "TÃ©lÃ©phone: " + (phone || "â€”") + "\n";
        msg += "Slug: " + (slug || "â€”") + "\n";
        msg += "Statut: " + (status || "â€”") + "\n\n";
        msg += "J'ai besoin d'aide. Merci. â€” DIGIY";
        wa(msg);
      };

      $("btnBack").onclick = safeBack;
      $("btnRefresh").onclick = function(){ checkStatus(true); };

      // BOUTON SAUVEGARDER INFOS CLIENT
      $("btnSaveInfo").onclick = function(){
        const prenom = $("inputPrenom").value.trim();
        const nom = $("inputNom").value.trim();
        const email = $("inputEmail").value.trim();
        
        if(!prenom || !nom) {
          alert("âš ï¸ PrÃ©nom et Nom sont obligatoires frÃ©rot!");
          return;
        }
        
        localStorage.setItem('digiy_prenom', prenom);
        localStorage.setItem('digiy_nom', nom);
        if(email) localStorage.setItem('digiy_email', email);
        
        $("clientInfoBox").style.display = 'none';
        setHint("âœ… Infos enregistrÃ©es! Clique sur 'Payer maintenant' ğŸ‘‡");
        
        // Scroll vers le bouton de paiement
        $("btnPayNow").scrollIntoView({ behavior: 'smooth', block: 'center' });
      };

      // PRÃ‰-REMPLIR SI DÃ‰JÃ€ ENREGISTRÃ‰
      const savedPrenom = localStorage.getItem('digiy_prenom');
      const savedNom = localStorage.getItem('digiy_nom');
      const savedEmail = localStorage.getItem('digiy_email');

      if(savedPrenom) $("inputPrenom").value = savedPrenom;
      if(savedNom) $("inputNom").value = savedNom;
      if(savedEmail) $("inputEmail").value = savedEmail;

      async function checkStatus(manual){
        $("btnRefresh").disabled = true;
        setHint("");

        if(status === "pending"){
          setBig("Paiement en attente.", "warn", "EN ATTENTE");
        }else{
          setBig("VÃ©rification...", "warn", "EN COURS");
        }

        if(!phone){
          setBig("TÃ©lÃ©phone manquant.", "bad", "INACTIF");
          setHint("On attend ?phone=+221...");
          $("btnBack").disabled = true;
          $("btnRefresh").disabled = false;
          return;
        }

        const m = (accessModule || "LOC").toUpperCase();

        try{
          const result = await sb.rpc("is_module_active", { p_phone: phone, p_module: m });
          const data = result.data;
          const error = result.error;
          
          if(error) throw error;

          const active = !!data;

          if(active){
            setQS("status", "active");
            status = "active";
            setBig("Abonnement ACTIF.", "ok", "ACTIF");
            setHint("Tu peux revenir au planning.");
            $("btnBack").disabled = false;
          }else{
            if(status === "pending"){
              setBig("Paiement EN ATTENTE.", "warn", "EN ATTENTE");
              setHint("Activation aprÃ¨s validation.");
              $("btnBack").disabled = true;
            }else{
              setBig("Abonnement INACTIF.", "bad", "INACTIF");
              setHint("Choisis un produit puis paie.");
              $("btnBack").disabled = true;
            }
          }
        }catch(e){
          console.error(e);
          setBig("Erreur vÃ©rification.", "bad", "ERREUR");
          setHint("Supabase: " + String(e.message || e));
          $("btnBack").disabled = true;
        }finally{
          $("btnRefresh").disabled = false;
        }
      }

      checkStatus(false);
    })();
  </script>
</body>
</html>
